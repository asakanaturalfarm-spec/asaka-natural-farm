<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="安積直売所 レジ・お支払い">
    <title>レジ | 安積直売所</title>
    <link rel="stylesheet" href="store-style.css?v=3">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@500;700&family=Noto+Sans+JP:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="store-script.js"></script>
    <script src="store-auth.js"></script>
    <script src="store-inventory-sync.js"></script>
    <script src="store-order-sync.js"></script>
    <script src="store-shipping-calculator.js"></script>
    <script src="store-notification-system.js"></script>
    <script src="store-payment-integration.js"></script>
    <script src="system-integration.js"></script>
    <script>
        // ログインチェック
        window.addEventListener('DOMContentLoaded', () => {
            if (!window.Auth || !window.Auth.isLoggedIn()) {
                alert('チェックアウトするにはログインが必要です。');
                window.location.href = 'login.html?redirect=checkout.html';
                return;
            }
        });
    </script>
    <style>
        .checkout-page {
            min-height: 100vh;
            background: var(--bg-cream);
            padding: 100px 40px;
        }

        .checkout-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .checkout-header {
            text-align: center;
            margin-bottom: 60px;
        }

        .checkout-header h1 {
            font-size: 40px;
            color: var(--text-dark);
            font-family: 'Noto Serif JP', serif;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .checkout-steps {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 60px;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .step-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--border-medium);
            color: var(--text-medium);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
        }

        .step.active .step-number {
            background: var(--primary-color);
            color: white;
        }

        .step.completed .step-number {
            background: var(--accent-gold);
            color: white;
        }

        .step-label {
            font-size: 15px;
            color: var(--text-medium);
        }

        .step.active .step-label {
            color: var(--text-dark);
            font-weight: 600;
        }

        .checkout-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 40px;
        }

        .checkout-form {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: var(--shadow-sm);
        }

        .form-section {
            margin-bottom: 40px;
            padding-bottom: 40px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .section-title {
            font-size: 22px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 24px;
            font-family: 'Noto Serif JP', serif;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .required {
            color: #dc3545;
            margin-left: 4px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid var(--border-medium);
            border-radius: 8px;
            font-size: 15px;
            font-family: 'Noto Sans JP', sans-serif;
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(61, 90, 61, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .payment-methods {
            display: grid;
            gap: 12px;
        }

        .payment-option {
            display: flex;
            align-items: center;
            padding: 16px;
            border: 2px solid var(--border-medium);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .payment-option:hover {
            border-color: var(--primary-color);
        }

        .payment-option input[type="radio"] {
            margin-right: 12px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .payment-option.selected {
            border-color: var(--primary-color);
            background: rgba(61, 90, 61, 0.05);
        }

        .payment-label {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .payment-icon {
            font-size: 24px;
        }

        .payment-info {
            flex: 1;
        }

        .payment-name {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 15px;
        }

        .payment-desc {
            font-size: 13px;
            color: var(--text-light);
            margin-top: 2px;
        }

        .order-summary {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: var(--shadow-sm);
            height: fit-content;
            position: sticky;
            top: 120px;
        }

        .summary-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 24px;
            font-family: 'Noto Serif JP', serif;
        }

        .order-items {
            margin-bottom: 24px;
        }

        .order-item {
            display: flex;
            gap: 16px;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .order-item:first-child {
            padding-top: 0;
        }

        .order-item-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-cream);
            flex-shrink: 0;
        }

        .order-item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .order-item-details {
            flex: 1;
        }

        .order-item-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .order-item-quantity {
            font-size: 13px;
            color: var(--text-light);
        }

        .order-item-price {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-dark);
            text-align: right;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .summary-row:last-of-type {
            border-bottom: 2px solid var(--border-medium);
            margin-bottom: 16px;
        }

        .summary-label {
            color: var(--text-medium);
            font-size: 15px;
        }

        .summary-value {
            color: var(--text-dark);
            font-weight: 600;
            font-size: 15px;
        }

        .summary-total {
            display: flex;
            justify-content: space-between;
            padding: 16px 0;
            margin-bottom: 32px;
        }

        .summary-total .summary-label {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .summary-total .summary-value {
            font-size: 24px;
            color: var(--primary-color);
        }

        .place-order-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 16px;
        }

        .place-order-btn:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .place-order-btn:disabled {
            background: var(--border-medium);
            cursor: not-allowed;
        }

        .back-to-cart {
            text-align: center;
        }

        .back-to-cart a {
            color: var(--text-medium);
            font-size: 14px;
            text-decoration: none;
        }

        .back-to-cart a:hover {
            color: var(--primary-color);
        }

        .secure-notice {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: rgba(61, 90, 61, 0.05);
            border-radius: 8px;
            font-size: 13px;
            color: var(--text-medium);
            margin-top: 16px;
        }

        .secure-icon {
            color: var(--primary-color);
        }

        @media (max-width: 768px) {
            .checkout-page {
                padding: 60px 20px;
            }

            .checkout-steps {
                gap: 20px;
                flex-wrap: wrap;
            }

            .step {
                flex: 1;
                min-width: 120px;
            }

            .checkout-content {
                grid-template-columns: 1fr;
            }

            .checkout-form {
                padding: 24px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .order-summary {
                position: static;
            }
        }
    </style>
</head>
<body>
    <div class="checkout-page">
        <div class="checkout-container">
            <div class="checkout-header">
                <h1>レジ</h1>
                
                <div class="checkout-steps">
                    <div class="step completed">
                        <div class="step-number">1</div>
                        <div class="step-label">カート</div>
                    </div>
                    <div class="step active">
                        <div class="step-number">2</div>
                        <div class="step-label">配送・支払い</div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-label">注文完了</div>
                    </div>
                </div>
            </div>

            <div class="checkout-content">
                <div class="checkout-form">
                    <form id="checkoutForm">
                        <!-- 配送先情報 -->
                        <div class="form-section">
                            <h2 class="section-title">配送先情報</h2>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>姓<span class="required">*</span></label>
                                    <input type="text" name="lastName" required minlength="1" maxlength="50" id="lastName">
                                    <small class="validation-error" style="color: #dc3545; font-size: 12px; display: none;" id="lastNameError">姓を入力してください</small>
                                </div>
                                <div class="form-group">
                                    <label>名<span class="required">*</span></label>
                                    <input type="text" name="firstName" required minlength="1" maxlength="50" id="firstName">
                                    <small class="validation-error" style="color: #dc3545; font-size: 12px; display: none;" id="firstNameError">名を入力してください</small>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>メールアドレス<span class="required">*</span></label>
                                <input type="email" name="email" required id="email">
                                <small class="validation-error" style="color: #dc3545; font-size: 12px; display: none;" id="emailError">有効なメールアドレスを入力してください</small>
                            </div>

                            <div class="form-group">
                                <label>電話番号<span class="required">*</span></label>
                                <input type="tel" name="phone" placeholder="090-1234-5678" required pattern="^0\d{1,4}-?\d{1,4}-?\d{4}$" id="phone">
                                <small class="validation-error" style="color: #dc3545; font-size: 12px; display: none;" id="phoneError">電話番号の形式が正しくありません（例: 090-1234-5678）</small>
                            </div>

                            <div class="form-group">
                                <label>郵便番号<span class="required">*</span></label>
                                <input type="text" name="postalCode" placeholder="123-4567" required pattern="^\d{3}-?\d{4}$" id="postalCode">
                                <small class="validation-error" style="color: #dc3545; font-size: 12px; display: none;" id="postalCodeError">郵便番号は「123-4567」の形式で入力してください</small>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>都道府県<span class="required">*</span></label>
                                    <select name="prefecture" required id="prefecture">
                                        <option value="">選択してください</option>
                                        <option value="北海道">北海道</option>
                                        <option value="青森県">青森県</option>
                                        <option value="岩手県">岩手県</option>
                                        <option value="宮城県">宮城県</option>
                                        <option value="秋田県">秋田県</option>
                                        <option value="山形県">山形県</option>
                                        <option value="福島県">福島県</option>
                                        <option value="茨城県">茨城県</option>
                                        <option value="栃木県">栃木県</option>
                                        <option value="群馬県">群馬県</option>
                                        <option value="埼玉県">埼玉県</option>
                                        <option value="千葉県">千葉県</option>
                                        <option value="東京都">東京都</option>
                                        <option value="神奈川県">神奈川県</option>
                                        <option value="新潟県">新潟県</option>
                                        <option value="富山県">富山県</option>
                                        <option value="石川県">石川県</option>
                                        <option value="福井県">福井県</option>
                                        <option value="山梨県">山梨県</option>
                                        <option value="長野県">長野県</option>
                                        <option value="岐阜県">岐阜県</option>
                                        <option value="静岡県">静岡県</option>
                                        <option value="愛知県">愛知県</option>
                                        <option value="三重県">三重県</option>
                                        <option value="滋賀県">滋賀県</option>
                                        <option value="京都府">京都府</option>
                                        <option value="大阪府">大阪府</option>
                                        <option value="兵庫県">兵庫県</option>
                                        <option value="奈良県">奈良県</option>
                                        <option value="和歌山県">和歌山県</option>
                                        <option value="鳥取県">鳥取県</option>
                                        <option value="島根県">島根県</option>
                                        <option value="岡山県">岡山県</option>
                                        <option value="広島県">広島県</option>
                                        <option value="山口県">山口県</option>
                                        <option value="徳島県">徳島県</option>
                                        <option value="香川県">香川県</option>
                                        <option value="愛媛県">愛媛県</option>
                                        <option value="高知県">高知県</option>
                                        <option value="福岡県">福岡県</option>
                                        <option value="佐賀県">佐賀県</option>
                                        <option value="長崎県">長崎県</option>
                                        <option value="熊本県">熊本県</option>
                                        <option value="大分県">大分県</option>
                                        <option value="宮崎県">宮崎県</option>
                                        <option value="鹿児島県">鹿児島県</option>
                                        <option value="沖縄県">沖縄県</option>
                                    </select>
                                    <small class="validation-error" style="color: #dc3545; font-size: 12px; display: none;" id="prefectureError">都道府県を選択してください</small>
                                </div>
                                <div class="form-group">
                                    <label>市区町村<span class="required">*</span></label>
                                    <input type="text" name="city" required minlength="1" maxlength="100" id="city">
                                    <small class="validation-error" style="color: #dc3545; font-size: 12px; display: none;" id="cityError">市区町村を入力してください</small>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>番地・建物名<span class="required">*</span></label>
                                <input type="text" name="address" placeholder="〇〇町1-2-3 〇〇マンション101" required minlength="1" maxlength="200" id="address">
                                <small class="validation-error" style="color: #dc3545; font-size: 12px; display: none;" id="addressError">番地・建物名を入力してください</small>
                            </div>

                            <div class="form-group">
                                <label>配送に関するメモ</label>
                                <textarea name="deliveryNote" placeholder="配送時間の希望や置き配など"></textarea>
                            </div>
                        </div>

                        <!-- お支払い方法 -->
                        <div class="form-section">
                            <h2 class="section-title">お支払い方法</h2>
                            
                            <div class="payment-methods">
                                <label class="payment-option selected">
                                    <input type="radio" name="paymentMethod" value="credit" checked>
                                    <div class="payment-label">
                                        <div class="payment-icon">💳</div>
                                        <div class="payment-info">
                                            <div class="payment-name">クレジットカード</div>
                                            <div class="payment-desc">Visa / Mastercard / JCB / AMEX</div>
                                        </div>
                                    </div>
                                </label>

                                <label class="payment-option">
                                    <input type="radio" name="paymentMethod" value="bank">
                                    <div class="payment-label">
                                        <div class="payment-icon">🏦</div>
                                        <div class="payment-info">
                                            <div class="payment-name">銀行振込</div>
                                            <div class="payment-desc">振込先は注文後にご案内</div>
                                        </div>
                                    </div>
                                </label>

                                <label class="payment-option">
                                    <input type="radio" name="paymentMethod" value="cod">
                                    <div class="payment-label">
                                        <div class="payment-icon">💰</div>
                                        <div class="payment-info">
                                            <div class="payment-name">代金引換</div>
                                            <div class="payment-desc">配達時に現金でお支払い（手数料¥300）</div>
                                        </div>
                                    </div>
                                </label>

                                <label class="payment-option">
                                    <input type="radio" name="paymentMethod" value="konbini">
                                    <div class="payment-label">
                                        <div class="payment-icon">🏪</div>
                                        <div class="payment-info">
                                            <div class="payment-name">コンビニ決済</div>
                                            <div class="payment-desc">セブン / ローソン / ファミマ</div>
                                        </div>
                                    </div>
                                </label>
                            </div>

                            <!-- 支払い方法別の詳細情報表示エリア -->
                            <div id="paymentDetails" style="margin-top: 24px; padding: 20px; background: #f8f9fa; border-radius: 8px; display: none;">
                                <div id="creditCardDetails" style="display: none;">
                                    <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">クレジットカード情報</h4>
                                    <p style="font-size: 14px; color: #666; margin-bottom: 12px;">注文確定後、決済ページに移動します。安全な暗号化通信で保護されています。</p>
                                    <ul style="font-size: 13px; color: #666; padding-left: 20px;">
                                        <li>Visa、Mastercard、JCB、American Express対応</li>
                                        <li>決済完了後、即座に注文が確定します</li>
                                    </ul>
                                </div>
                                <div id="bankTransferDetails" style="display: none;">
                                    <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">銀行振込について</h4>
                                    <p style="font-size: 14px; color: #666; margin-bottom: 12px;">ご注文確定後、振込先口座情報をメールでお送りします。</p>
                                    <ul style="font-size: 13px; color: #666; padding-left: 20px;">
                                        <li>ご入金確認後、3営業日以内に発送します</li>
                                        <li>振込手数料はお客様負担となります</li>
                                        <li>ご注文から7日以内にお振込みください</li>
                                    </ul>
                                </div>
                                <div id="codDetails" style="display: none;">
                                    <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">代金引換について</h4>
                                    <p style="font-size: 14px; color: #666; margin-bottom: 12px;">商品受取時に配達員へ現金でお支払いください。</p>
                                    <ul style="font-size: 13px; color: #666; padding-left: 20px;">
                                        <li>代引手数料: ¥300</li>
                                        <li>お釣りのないようご準備いただけると助かります</li>
                                        <li>配達時にご不在の場合、再配達となります</li>
                                    </ul>
                                </div>
                                <div id="konbiniDetails" style="display: none;">
                                    <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">コンビニ決済について</h4>
                                    <p style="font-size: 14px; color: #666; margin-bottom: 12px;">ご注文確定後、お支払い番号をメールでお送りします。</p>
                                    <ul style="font-size: 13px; color: #666; padding-left: 20px;">
                                        <li>対応店舗: セブンイレブン、ローソン、ファミリーマート</li>
                                        <li>お支払い確認後、3営業日以内に発送します</li>
                                        <li>ご注文から7日以内にお支払いください</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="order-summary">
                    <h3 class="summary-title">注文内容</h3>
                    
                    <div class="order-items" id="orderItems">
                        <!-- JavaScriptで動的に生成 -->
                    </div>
                    
                    <div class="summary-row">
                        <span class="summary-label">小計</span>
                        <span class="summary-value" id="subtotalAmount">¥0</span>
                    </div>
                    
                    <div class="summary-row">
                        <span class="summary-label">送料</span>
                        <span class="summary-value" id="shippingAmount">¥500</span>
                    </div>
                    
                    <div class="summary-row" id="codFeeRow" style="display: none;">
                        <span class="summary-label">代引手数料</span>
                        <span class="summary-value">¥300</span>
                    </div>
                    
                    <div class="summary-total">
                        <span class="summary-label">合計</span>
                        <span class="summary-value" id="totalAmount">¥0</span>
                    </div>

                    <!-- 在庫不足の警告メッセージ -->
                    <div id="inventoryWarning" style="display: none; background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <span style="font-size: 24px;">⚠️</span>
                            <div style="flex: 1;">
                                <h4 style="font-size: 16px; font-weight: 600; color: #856404; margin: 0 0 12px 0;">在庫不足のお知らせ</h4>
                                <div id="inventoryWarningMessage" style="font-size: 14px; color: #856404; line-height: 1.6;"></div>
                                <p style="font-size: 13px; color: #856404; margin: 12px 0 0 0; font-weight: 600;">
                                    ※ ご注文内容を自動的に調整いたしました。ご了承ください。
                                </p>
                            </div>
                        </div>
                    </div>

                    <button class="place-order-btn" onclick="placeOrder()">注文を確定する</button>
                    
                    <div class="back-to-cart">
                        <a href="store-cart.html">← カートに戻る</a>
                    </div>

                    <div class="secure-notice">
                        <span class="secure-icon">🔒</span>
                        <span>安全な通信で保護されています</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // カートデータを取得
        let cartItems = [];
        let inventoryAdjusted = false;
        let adjustedItems = [];
        
        try {
            const savedCart = localStorage.getItem('cartItems');
            if (savedCart) {
                cartItems = JSON.parse(savedCart);
            }
        } catch (e) {
            console.error('カートデータの読み込みエラー:', e);
        }

        // カートが空の場合はカートページへリダイレクト
        if (cartItems.length === 0) {
            alert('カートが空です');
            window.location.href = 'cart.html';
        }

        // 在庫チェックと自動調整
        function checkAndAdjustInventory() {
            if (typeof window.checkInventoryAvailability !== 'function') {
                console.warn('在庫チェック機能が利用できません');
                return;
            }

            const inventoryCheck = window.checkInventoryAvailability(cartItems);
            
            if (!inventoryCheck.available && inventoryCheck.unavailableItems.length > 0) {
                inventoryAdjusted = true;
                adjustedItems = [];
                
                // 在庫不足の商品を調整
                inventoryCheck.unavailableItems.forEach(unavailable => {
                    const cartItem = cartItems.find(item => item.name === unavailable.name);
                    if (cartItem) {
                        const originalQuantity = cartItem.quantity;
                        const availableQuantity = Math.max(0, Math.floor(unavailable.available));
                        
                        adjustedItems.push({
                            name: unavailable.name,
                            requested: originalQuantity,
                            available: availableQuantity,
                            adjusted: availableQuantity
                        });
                        
                        if (availableQuantity > 0) {
                            // 在庫がある場合は数量を調整
                            cartItem.quantity = availableQuantity;
                        } else {
                            // 在庫がない場合は商品を削除
                            const index = cartItems.indexOf(cartItem);
                            if (index > -1) {
                                cartItems.splice(index, 1);
                            }
                        }
                    }
                });
                
                // 調整後のカートを保存
                localStorage.setItem('cartItems', JSON.stringify(cartItems));
                
                // 警告メッセージを表示
                showInventoryWarning(adjustedItems);
            }
        }

        // 在庫不足の警告を表示
        function showInventoryWarning(adjustedItems) {
            const warningDiv = document.getElementById('inventoryWarning');
            const messageDiv = document.getElementById('inventoryWarningMessage');
            
            let message = '<p style="margin: 0 0 12px 0; font-weight: 600;">誠に申し訳ございません。以下の商品について在庫不足が発生しました：</p>';
            message += '<ul style="margin: 0; padding-left: 20px;">';
            
            adjustedItems.forEach(item => {
                if (item.adjusted > 0) {
                    message += `<li style="margin: 8px 0;"><strong>${item.name}</strong>：ご注文数 ${item.requested}個 → 在庫数 ${item.adjusted}個に調整</li>`;
                } else {
                    message += `<li style="margin: 8px 0;"><strong>${item.name}</strong>：在庫切れのため削除しました（ご注文数 ${item.requested}個）</li>`;
                }
            });
            
            message += '</ul>';
            message += '<p style="margin: 12px 0 0 0;">在庫状況により、ご希望の数量をご用意できず、大変申し訳ございません。調整後の内容でよろしければ、そのままご注文を進めていただけます。</p>';
            
            messageDiv.innerHTML = message;
            warningDiv.style.display = 'block';
            
            // 警告エリアまでスクロール
            setTimeout(() => {
                warningDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        }

        // 在庫チェックを実行
        checkAndAdjustInventory();

        // カートが空になった場合はカートページへリダイレクト
        if (cartItems.length === 0) {
            alert('申し訳ございません。すべての商品が在庫切れのため、ご注文を承ることができません。\nカートページに戻ります。');
            window.location.href = 'cart.html';
        }

        // 最低注文金額チェック
        const subtotalCheck = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const MINIMUM_ORDER = 4500;
        if (subtotalCheck < MINIMUM_ORDER) {
            alert(`最低注文金額は¥4,500です（送料別）。\n現在の小計: ¥${subtotalCheck.toLocaleString()}\n${inventoryAdjusted ? '在庫調整により最低注文金額を下回ってしまいました。' : ''}カートに戻って商品を追加してください。`);
            window.location.href = 'cart.html';
        }

        // 注文サマリーを表示
        function renderOrderSummary() {
            const orderItemsContainer = document.getElementById('orderItems');
            const subtotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const shipping = 500;
            let codFee = 0;

            // 支払い方法による手数料
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            if (paymentMethod === 'cod') {
                codFee = 300;
                document.getElementById('codFeeRow').style.display = 'flex';
            } else {
                document.getElementById('codFeeRow').style.display = 'none';
            }

            const total = subtotal + shipping + codFee;

            // 商品一覧を表示
            orderItemsContainer.innerHTML = cartItems.map(item => `
                <div class="order-item">
                    <div class="order-item-image">
                        <img src="${item.image}" alt="${item.name}">
                    </div>
                    <div class="order-item-details">
                        <div class="order-item-name">${item.name}</div>
                        <div class="order-item-quantity">数量: ${item.quantity}</div>
                    </div>
                    <div class="order-item-price">¥${(item.price * item.quantity).toLocaleString()}</div>
                </div>
            `).join('');

            // 金額を更新
            document.getElementById('subtotalAmount').textContent = `¥${subtotal.toLocaleString()}`;
            document.getElementById('totalAmount').textContent = `¥${total.toLocaleString()}`;
        }

        // 入力フィールドのリアルタイムバリデーション
        function setupValidation() {
            // 郵便番号
            const postalCode = document.getElementById('postalCode');
            const postalCodeError = document.getElementById('postalCodeError');
            postalCode.addEventListener('blur', function() {
                validatePostalCode();
                // 郵便番号が有効な場合、住所を自動入力
                if (validatePostalCode()) {
                    autoFillAddress();
                }
            });
            postalCode.addEventListener('input', function() {
                // 入力中もリアルタイムでチェック
                if (this.value.length >= 7) {
                    validatePostalCode();
                    // 7桁入力されたら自動で住所を取得
                    const cleaned = this.value.replace('-', '');
                    if (cleaned.length === 7) {
                        autoFillAddress();
                    }
                }
            });

            // 電話番号
            const phone = document.getElementById('phone');
            const phoneError = document.getElementById('phoneError');
            phone.addEventListener('blur', function() {
                validatePhone();
            });
            phone.addEventListener('input', function() {
                // 入力中もリアルタイムでチェック
                if (this.value.length >= 10) {
                    validatePhone();
                }
            });

            // メールアドレス
            const email = document.getElementById('email');
            const emailError = document.getElementById('emailError');
            email.addEventListener('blur', function() {
                validateEmail();
            });

            // 都道府県
            const prefecture = document.getElementById('prefecture');
            const prefectureError = document.getElementById('prefectureError');
            prefecture.addEventListener('change', function() {
                validatePrefecture();
            });

            // 市区町村
            const city = document.getElementById('city');
            const cityError = document.getElementById('cityError');
            city.addEventListener('blur', function() {
                validateCity();
            });

            // 番地・建物名
            const address = document.getElementById('address');
            const addressError = document.getElementById('addressError');
            address.addEventListener('blur', function() {
                validateAddress();
            });

            // 姓・名
            ['lastName', 'firstName'].forEach(fieldId => {
                const field = document.getElementById(fieldId);
                const error = document.getElementById(fieldId + 'Error');
                if (field && error) {
                    field.addEventListener('blur', function() {
                        if (this.value.trim() === '') {
                            error.style.display = 'block';
                            this.style.borderColor = '#dc3545';
                        } else {
                            error.style.display = 'none';
                            this.style.borderColor = '';
                        }
                    });
                }
            });
        }

        // 個別のバリデーション関数
        function validatePostalCode() {
            const postalCode = document.getElementById('postalCode');
            const postalCodeError = document.getElementById('postalCodeError');
            const value = postalCode.value.trim();
            const pattern = /^\d{3}-?\d{4}$/;
            
            if (value === '' || !pattern.test(value)) {
                postalCodeError.style.display = 'block';
                postalCode.style.borderColor = '#dc3545';
                return false;
            } else {
                postalCodeError.style.display = 'none';
                postalCode.style.borderColor = '#28a745';
                return true;
            }
        }

        // 郵便番号から住所を自動入力する機能
        async function autoFillAddress() {
            const postalCode = document.getElementById('postalCode').value.trim().replace('-', '');
            
            if (postalCode.length !== 7) {
                return;
            }

            try {
                const response = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${postalCode}`);
                const data = await response.json();

                if (data.status === 200 && data.results && data.results.length > 0) {
                    const result = data.results[0];
                    const prefecture = result.address1; // 都道府県
                    const city = result.address2; // 市区町村
                    const town = result.address3; // 町域

                    // 都道府県を自動選択
                    const prefectureSelect = document.getElementById('prefecture');
                    const prefectureOption = Array.from(prefectureSelect.options).find(option => option.value === prefecture);
                    if (prefectureOption) {
                        prefectureSelect.value = prefecture;
                        validatePrefecture();
                    }

                    // 市区町村を自動入力
                    const cityInput = document.getElementById('city');
                    if (!cityInput.value.trim()) {
                        cityInput.value = city;
                        validateCity();
                    }

                    // 町域がある場合、番地フィールドに提案
                    if (town && !document.getElementById('address').value.trim()) {
                        document.getElementById('address').placeholder = `${town}1-2-3 〇〇マンション101`;
                    }

                    // 成功メッセージを一時的に表示
                    const postalCodeError = document.getElementById('postalCodeError');
                    postalCodeError.textContent = `✓ 住所を自動入力しました: ${prefecture}${city}`;
                    postalCodeError.style.color = '#28a745';
                    postalCodeError.style.display = 'block';
                    setTimeout(() => {
                        postalCodeError.style.display = 'none';
                        postalCodeError.style.color = '#dc3545';
                        postalCodeError.textContent = '郵便番号は「123-4567」の形式で入力してください';
                    }, 3000);
                }
            } catch (error) {
                console.error('住所自動入力エラー:', error);
            }
        }

        function validatePhone() {
            const phone = document.getElementById('phone');
            const phoneError = document.getElementById('phoneError');
            const value = phone.value.trim();
            // より厳格な電話番号パターン（ハイフンありなし両対応）
            const pattern = /^(0\d{1,4}-\d{1,4}-\d{4}|0\d{9,10})$/;
            
            if (value === '' || !pattern.test(value)) {
                phoneError.style.display = 'block';
                phone.style.borderColor = '#dc3545';
                return false;
            } else {
                phoneError.style.display = 'none';
                phone.style.borderColor = '#28a745';
                return true;
            }
        }

        function validateEmail() {
            const email = document.getElementById('email');
            const emailError = document.getElementById('emailError');
            const value = email.value.trim();
            const pattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (value === '' || !pattern.test(value)) {
                emailError.style.display = 'block';
                email.style.borderColor = '#dc3545';
                return false;
            } else {
                emailError.style.display = 'none';
                email.style.borderColor = '#28a745';
                return true;
            }
        }

        function validatePrefecture() {
            const prefecture = document.getElementById('prefecture');
            const prefectureError = document.getElementById('prefectureError');
            
            if (prefecture.value === '') {
                prefectureError.style.display = 'block';
                prefecture.style.borderColor = '#dc3545';
                return false;
            } else {
                prefectureError.style.display = 'none';
                prefecture.style.borderColor = '#28a745';
                return true;
            }
        }

        function validateCity() {
            const city = document.getElementById('city');
            const cityError = document.getElementById('cityError');
            const value = city.value.trim();
            
            // 市区町村は最低2文字以上、全角文字を含む必要がある
            if (value === '' || value.length < 2 || !/[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF]/.test(value)) {
                cityError.textContent = '有効な市区町村名を入力してください（例: 郡山市）';
                cityError.style.display = 'block';
                city.style.borderColor = '#dc3545';
                return false;
            } else {
                cityError.style.display = 'none';
                city.style.borderColor = '#28a745';
                return true;
            }
        }

        function validateAddress() {
            const address = document.getElementById('address');
            const addressError = document.getElementById('addressError');
            const value = address.value.trim();
            
            // 番地は最低3文字以上、数字を含む必要がある
            if (value === '' || value.length < 3 || !/\d/.test(value)) {
                addressError.textContent = '有効な番地を入力してください（例: 安積町1-2-3）';
                addressError.style.display = 'block';
                address.style.borderColor = '#dc3545';
                return false;
            } else {
                addressError.style.display = 'none';
                address.style.borderColor = '#28a745';
                return true;
            }
        }

        // 郵便番号から住所を検証する関数
        async function verifyAddressWithPostalCode() {
            const postalCode = document.getElementById('postalCode').value.trim().replace('-', '');
            const prefecture = document.getElementById('prefecture').value;
            const city = document.getElementById('city').value.trim();
            
            if (!postalCode || postalCode.length !== 7) {
                return { valid: false, message: '郵便番号が正しくありません' };
            }

            try {
                // 郵便番号検索APIを使用（無料のzipcloudを使用）
                const response = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${postalCode}`);
                const data = await response.json();

                if (data.status === 200 && data.results && data.results.length > 0) {
                    const result = data.results[0];
                    const apiPrefecture = result.address1; // 都道府県
                    const apiCity = result.address2; // 市区町村
                    
                    // 都道府県が一致するかチェック
                    if (prefecture !== apiPrefecture) {
                        return {
                            valid: false,
                            message: `郵便番号「${postalCode}」は「${apiPrefecture}」の郵便番号です。\n選択された都道府県「${prefecture}」と一致しません。`,
                            suggestedPrefecture: apiPrefecture,
                            suggestedCity: apiCity
                        };
                    }

                    // 市区町村が含まれているかチェック（完全一致でなくても部分一致でOK）
                    if (!city.includes(apiCity) && !apiCity.includes(city)) {
                        return {
                            valid: false,
                            message: `郵便番号「${postalCode}」は「${apiPrefecture}${apiCity}」の郵便番号です。\n入力された市区町村「${city}」と一致しません。`,
                            suggestedPrefecture: apiPrefecture,
                            suggestedCity: apiCity
                        };
                    }

                    return { 
                        valid: true, 
                        message: '住所が確認できました',
                        verifiedAddress: `${apiPrefecture}${apiCity}`
                    };
                } else {
                    return { 
                        valid: false, 
                        message: `郵便番号「${postalCode}」に該当する住所が見つかりませんでした。\n正しい郵便番号を入力してください。`
                    };
                }
            } catch (error) {
                console.error('住所検証エラー:', error);
                // ネットワークエラーの場合は基本的なバリデーションのみで通す
                return { 
                    valid: true, 
                    message: '住所検証サービスに接続できませんでした。基本チェックのみ実施します。',
                    warning: true
                };
            }
        }

        // 支払い方法詳細の表示切り替え
        function showPaymentDetails(method) {
            const detailsArea = document.getElementById('paymentDetails');
            const allDetails = ['creditCardDetails', 'bankTransferDetails', 'codDetails', 'konbiniDetails'];
            
            // すべて非表示
            allDetails.forEach(id => {
                document.getElementById(id).style.display = 'none';
            });

            // 選択された支払い方法の詳細を表示
            let targetId = '';
            switch(method) {
                case 'credit':
                    targetId = 'creditCardDetails';
                    break;
                case 'bank':
                    targetId = 'bankTransferDetails';
                    break;
                case 'cod':
                    targetId = 'codDetails';
                    break;
                case 'konbini':
                    targetId = 'konbiniDetails';
                    break;
            }

            if (targetId) {
                detailsArea.style.display = 'block';
                document.getElementById(targetId).style.display = 'block';
            }
        }

        // 支払いオプションの選択状態を管理
        document.querySelectorAll('.payment-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                const radio = this.querySelector('input[type="radio"]');
                radio.checked = true;
                showPaymentDetails(radio.value); // 支払い詳細を表示
                renderOrderSummary(); // 代引手数料の表示切り替え
            });
        });

        // 発送先情報の詳細バリデーション
        function validateShippingInfo() {
            let isValid = true;
            const errors = [];

            // 姓・名
            const lastName = document.getElementById('lastName').value.trim();
            const firstName = document.getElementById('firstName').value.trim();
            if (!lastName || lastName.length === 0) {
                errors.push('姓を入力してください');
                document.getElementById('lastNameError').style.display = 'block';
                document.getElementById('lastName').style.borderColor = '#dc3545';
                isValid = false;
            }
            if (!firstName || firstName.length === 0) {
                errors.push('名を入力してください');
                document.getElementById('firstNameError').style.display = 'block';
                document.getElementById('firstName').style.borderColor = '#dc3545';
                isValid = false;
            }

            // 個別のバリデーション関数を呼び出す
            if (!validateEmail()) {
                errors.push('有効なメールアドレスを入力してください');
                isValid = false;
            }

            if (!validatePhone()) {
                errors.push('有効な電話番号を入力してください（例: 090-1234-5678 または 09012345678）');
                isValid = false;
            }

            if (!validatePostalCode()) {
                errors.push('有効な郵便番号を入力してください（例: 123-4567 または 1234567）');
                isValid = false;
            }

            if (!validatePrefecture()) {
                errors.push('都道府県を選択してください');
                isValid = false;
            }

            if (!validateCity()) {
                errors.push('有効な市区町村名を入力してください（例: 郡山市）');
                isValid = false;
            }

            if (!validateAddress()) {
                errors.push('有効な番地を入力してください（例: 安積町1-2-3）');
                isValid = false;
            }

            if (!isValid) {
                // エラーメッセージをより見やすく表示
                alert('❌ 発送先情報に不備があります\n\n' + errors.map((e, i) => `${i + 1}. ${e}`).join('\n') + '\n\n正しい情報を入力してください。');
                // 最初のエラーフィールドにフォーカス
                const firstErrorField = document.querySelector('input[style*="border-color: rgb(220, 53, 69)"], select[style*="border-color: rgb(220, 53, 69)"]');
                if (firstErrorField) {
                    firstErrorField.focus();
                    firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            return isValid;
        }

        // 支払い方法別の処理
        function processPayment(orderData) {
            const paymentMethod = orderData.paymentMethod;
            
            switch(paymentMethod) {
                case 'credit':
                    // クレジットカード決済の場合
                    console.log('クレジットカード決済を処理します');
                    // 実際には決済代行サービスのAPIを呼び出す
                    // 例: Stripe, PAY.JP, GMOペイメントゲートウェイなど
                    // return initiateCreditCardPayment(orderData);
                    orderData.paymentStatus = 'pending'; // 決済待ち
                    orderData.paymentInstructions = 'クレジットカード決済画面に移動します。';
                    break;

                case 'bank':
                    // 銀行振込の場合
                    console.log('銀行振込の注文を処理します');
                    orderData.paymentStatus = 'awaiting_transfer'; // 振込待ち
                    orderData.paymentInstructions = '振込先口座情報をメールでお送りしました。7日以内にお振込みください。';
                    orderData.bankInfo = {
                        bankName: '〇〇銀行',
                        branchName: '〇〇支店',
                        accountType: '普通',
                        accountNumber: '1234567',
                        accountHolder: '安積直売所'
                    };
                    break;

                case 'cod':
                    // 代金引換の場合
                    console.log('代金引換の注文を処理します');
                    orderData.paymentStatus = 'cod_pending'; // 配達時支払い
                    orderData.paymentInstructions = '商品受取時に配達員へ現金でお支払いください。';
                    orderData.codAmount = orderData.subtotal + orderData.shipping + orderData.codFee;
                    break;

                case 'konbini':
                    // コンビニ決済の場合
                    console.log('コンビニ決済の注文を処理します');
                    orderData.paymentStatus = 'awaiting_payment'; // 支払い待ち
                    orderData.paymentInstructions = 'お支払い番号をメールでお送りしました。7日以内にコンビニでお支払いください。';
                    // 支払い番号を生成（実際にはAPIから取得）
                    orderData.paymentNumber = 'KB-' + Date.now().toString().slice(-10);
                    break;

                default:
                    console.error('不明な支払い方法:', paymentMethod);
                    return false;
            }

            orderData.orderDate = new Date().toISOString();
            orderData.orderId = 'ORD-' + Date.now();
            
            return true;
        }

        // 注文確定
        async function placeOrder() {
            const form = document.getElementById('checkoutForm');
            
            // 基本的なフォームバリデーション
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // 発送先情報の詳細バリデーション
            if (!validateShippingInfo()) {
                return;
            }

            // 最低注文金額の再チェック
            const subtotalCheck = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const MINIMUM_ORDER = 4500;
            
            if (subtotalCheck < MINIMUM_ORDER) {
                alert(`最低注文金額は¥4,500です（送料別）。\n現在の小計: ¥${subtotalCheck.toLocaleString()}\nカートに戻って商品を追加してください。`);
                window.location.href = 'cart.html';
                return;
            }

            // 住所の実在性を確認
            const placeOrderBtn = document.querySelector('.place-order-btn');
            placeOrderBtn.disabled = true;
            placeOrderBtn.textContent = '住所を確認中...';
            
            const addressVerification = await verifyAddressWithPostalCode();
            
            if (!addressVerification.valid) {
                placeOrderBtn.disabled = false;
                placeOrderBtn.textContent = '注文を確定する';
                
                // 住所が実在しない場合は詳細なエラーを表示
                let errorMessage = '❌ 入力された住所を確認できませんでした\n\n' + addressVerification.message;
                
                if (addressVerification.suggestedPrefecture && addressVerification.suggestedCity) {
                    errorMessage += `\n\n💡 正しい住所:\n${addressVerification.suggestedPrefecture}${addressVerification.suggestedCity}`;
                }
                
                errorMessage += '\n\n入力内容を確認して、正しい住所を入力してください。';
                
                alert(errorMessage);
                
                // 郵便番号フィールドにフォーカス
                document.getElementById('postalCode').focus();
                document.getElementById('postalCode').scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }
            
            // 警告がある場合は表示（接続エラーなど）
            if (addressVerification.warning) {
                console.warn(addressVerification.message);
            }
            
            placeOrderBtn.textContent = '注文を処理中...';
            placeOrderBtn.style.background = '#28a745';

            const formData = new FormData(form);
            
            // ログインユーザー情報を取得
            const currentUser = window.Auth ? window.Auth.getCurrentUser() : null;
            if (!currentUser) {
                alert('ログインセッションが切れました。再度ログインしてください。');
                window.location.href = 'login.html?redirect=checkout.html';
                return;
            }
            
            // 1. セッション作成
            if (typeof createCheckoutSession === 'function') {
                createCheckoutSession(cartItems);
            }
            
            // 2. サーバー側で金額再計算（改ざん防止）
            let serverCalculation;
            try {
                if (typeof recalculateOrderTotal === 'function') {
                    placeOrderBtn.textContent = '金額を検証中...';
                    serverCalculation = recalculateOrderTotal(cartItems);
                    console.log('[金額再計算]', serverCalculation);
                } else {
                    throw new Error('金額計算システムが利用できません');
                }
            } catch (error) {
                alert('金額計算エラー: ' + error.message);
                placeOrderBtn.disabled = false;
                placeOrderBtn.textContent = '注文を確定する';
                placeOrderBtn.style.background = '';
                return;
            }
            
            // 3. 注文データ作成
            const orderData = {
                orderId: 'ORD_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                userId: currentUser.id,
                customerInfo: {
                    lastName: formData.get('lastName'),
                    firstName: formData.get('firstName'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                },
                shippingInfo: {
                    postalCode: formData.get('postalCode'),
                    prefecture: formData.get('prefecture'),
                    city: formData.get('city'),
                    address: formData.get('address'),
                    note: formData.get('deliveryNote')
                },
                paymentMethod: formData.get('paymentMethod'),
                items: serverCalculation.items,  // サーバー計算値を使用
                amounts: {
                    subtotal: serverCalculation.subtotal,
                    tax: serverCalculation.totalTax,
                    shipping: serverCalculation.shippingTotal,
                    total: serverCalculation.finalTotal
                },
                calculationHash: serverCalculation.calculationHash,
                createdAt: new Date().toISOString()
            };

            console.log('[注文データ]', orderData);

            // 4. 決済処理
            try {
                placeOrderBtn.textContent = '決済処理中...';
                
                const paymentMethod = formData.get('paymentMethod');
                let paymentConfig;
                
                // 決済方法別の設定
                switch(paymentMethod) {
                    case 'credit':
                        paymentConfig = {
                            type: window.PAYMENT_PROVIDERS.STRIPE,
                            // 実装時: Stripe Elements のカード要素を取得
                            cardElement: null,  
                            clientSecret: null  // サーバーから取得
                        };
                        break;
                        
                    case 'konbini':
                        paymentConfig = {
                            type: window.PAYMENT_PROVIDERS.KONBINI
                        };
                        break;
                        
                    case 'paypay':
                        paymentConfig = {
                            type: window.PAYMENT_PROVIDERS.PAYPAY,
                            returnUrl: window.location.origin + '/order-complete.html'
                        };
                        break;
                        
                    case 'cod':
                        // 代金引換は決済不要
                        paymentConfig = { type: 'cod' };
                        break;
                        
                    default:
                        throw new Error('サポートされていない決済方法です');
                }
                
                // 決済マネージャーで処理
                let paymentResult;
                
                if (paymentConfig.type === 'cod') {
                    // 代金引換の場合は決済処理スキップ
                    paymentResult = {
                        success: true,
                        paymentMethod: 'cod',
                        message: '配達時に現金でお支払いください'
                    };
                } else if (window.PaymentManager) {
                    const paymentManager = new window.PaymentManager();
                    
                    // Stripe初期化（実装時: 実際のAPIキーを使用）
                    if (paymentConfig.type === window.PAYMENT_PROVIDERS.STRIPE) {
                        // await paymentManager.initializeStripe('pk_test_xxxxx');
                        // 開発中は仮の成功レスポンス
                        paymentResult = {
                            success: true,
                            paymentId: 'dev_payment_' + Date.now(),
                            message: '【開発モード】決済処理が完了しました'
                        };
                    } else {
                        // 実際の決済処理
                        // paymentResult = await paymentManager.processPayment(orderData, paymentConfig);
                        
                        // 開発中は仮の成功レスポンス
                        paymentResult = {
                            success: true,
                            paymentId: 'dev_payment_' + Date.now(),
                            message: '【開発モード】決済処理が完了しました'
                        };
                    }
                } else {
                    // PaymentManagerが利用できない場合
                    console.warn('[決済] PaymentManagerが見つかりません。開発モードで続行します。');
                    paymentResult = {
                        success: true,
                        paymentId: 'dev_payment_' + Date.now(),
                        message: '【開発モード】決済処理をスキップしました'
                    };
                }
                
                if (!paymentResult.success) {
                    throw new Error(paymentResult.error || '決済処理に失敗しました');
                }
                
                console.log('[決済完了]', paymentResult);
                
                // 注文データに決済情報を追加
                orderData.payment = {
                    method: paymentMethod,
                    status: 'completed',
                    paymentId: paymentResult.paymentId,
                    processedAt: new Date().toISOString()
                };
                
            } catch (error) {
                console.error('[決済エラー]', error);
                alert('決済処理中にエラーが発生しました: ' + error.message);
                placeOrderBtn.disabled = false;
                placeOrderBtn.textContent = '注文を確定する';
                placeOrderBtn.style.background = '';
                return;
            }

            // 5. 統合注文管理システムに注文を登録
            // 5. 統合注文管理システムに注文を登録
            if (window.OrderSync) {
                try {
                    placeOrderBtn.textContent = '注文を登録中...';
                    
                    // 注文データを統合システムに追加
                    const orderResult = window.OrderSync.addOrder({
                        orderNumber: orderData.orderId,
                        customerInfo: orderData.customerInfo,
                        items: orderData.items.map(item => ({
                            productId: item.id,
                            productName: item.name,
                            quantity: item.quantity,
                            unitPrice: item.price
                        })),
                        totalAmount: orderData.amounts.total,
                        shippingInfo: orderData.shippingInfo,
                        paymentMethod: orderData.paymentMethod,
                        notes: orderData.shippingInfo.note
                    }, window.ORDER_SOURCE.EC_SITE);

                    if (!orderResult.success) {
                        if (orderResult.error === 'duplicate') {
                            console.warn('⚠ この注文は既に処理済みです');
                        } else {
                            throw new Error('注文登録に失敗しました: ' + orderResult.error);
                        }
                    } else {
                        console.log('✓ 注文を統合システムに登録しました:', orderResult.orderId);
                        
                        // 在庫処理を実行（重複防止付き）
                        placeOrderBtn.textContent = '在庫を更新中...';
                        const inventoryResult = window.OrderSync.processInventory(orderResult.orderId);
                        
                        if (!inventoryResult.success) {
                            if (inventoryResult.error === 'already_processed') {
                                console.warn('⚠ この注文の在庫は既に処理済みです');
                            } else if (inventoryResult.error === 'insufficient_stock') {
                                alert(`在庫不足: ${inventoryResult.productName}\n現在の在庫: ${inventoryResult.available}\n注文数量: ${inventoryResult.requested}`);
                                
                                // ロールバック実行
                                if (typeof releasePurchaseLock === 'function') {
                                    orderData.items.forEach(item => {
                                        releasePurchaseLock(item.id, currentUser.id);
                                    });
                                }
                                
                                placeOrderBtn.disabled = false;
                                placeOrderBtn.textContent = '注文を確定する';
                                placeOrderBtn.style.background = '';
                                return;
                            } else {
                                throw new Error('在庫処理に失敗しました: ' + inventoryResult.error);
                            }
                        } else {
                            console.log('✓ 在庫を更新しました');
                        }
                    }
                } catch (error) {
                    console.error('注文処理エラー:', error);
                    alert('注文処理中にエラーが発生しました: ' + error.message);
                    placeOrderBtn.disabled = false;
                    placeOrderBtn.textContent = '注文を確定する';
                    placeOrderBtn.style.background = '';
                    return;
                }
            }
            
            // 6. 注文履歴に追加
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const newOrder = {
                userId: currentUser.id,
                orderNumber: orderData.orderId,
                orderDate: orderData.orderDate,
                status: 'pending', // 注文ステータス
                items: orderData.items,
                subtotal: orderData.subtotal,
                shipping: orderData.shipping,
                codFee: orderData.codFee,
                total: orderData.subtotal + orderData.shipping + orderData.codFee,
                customer: orderData.customer,
                shippingAddress: orderData.shipping,
                paymentMethod: orderData.paymentMethod,
                paymentStatus: orderData.paymentStatus
            };
            orders.push(newOrder);
            localStorage.setItem('orders', JSON.stringify(orders));
            console.log('✓ 注文履歴に追加しました');
                    placeOrderBtn.textContent = '注文を確定する';
                    placeOrderBtn.style.background = '';
                    return;
                }
            } else {
                console.warn('⚠ 統合注文管理システムが読み込まれていません');
            }

            // 注文データを保存（後方互換性のため）
            localStorage.setItem('lastOrder', JSON.stringify(orderData));

            // 7. カートをクリア
            placeOrderBtn.textContent = '注文を完了しています...';
            localStorage.removeItem('cartItems');
            console.log('✓ カートをクリアしました');
            
            // 8. セッションクリア
            if (typeof clearCheckoutSession === 'function') {
                clearCheckoutSession();
            }
            
            console.log('✅ 注文処理が完了しました');
            
            placeOrderBtn.textContent = '注文完了！';
            placeOrderBtn.style.background = '#28a745';

            // 注文完了ページへリダイレクト
            setTimeout(() => {
                window.location.href = 'order-complete.html?orderId=' + orderData.orderId;
            }, 500);
        }

        // 初期表示
        renderOrderSummary();
        setupValidation();
        showPaymentDetails('credit'); // デフォルトのクレジットカード詳細を表示
    </script>
</body>
</html>
