<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™ºé€å®ŒäºEï¿½ï¿½çŸ¥ç®¡çE| å®‰ç©ç›´å£²æ‰€ ç®¡çEï¿½ï¿½é¢</title>
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@500;700&family=Noto+Sans+JP:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="../asaka-hub.js"></script>
    <script src="../sync-with-orders.js"></script>
    <script src="../notification-system.js"></script>
    <script src="admin-notification-manager.js"></script>
    <script src="email-history-manager.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: #f5f5f5;
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .admin-header {
            background: linear-gradient(135deg, #2c5f2d 0%, #3a7f3b 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .admin-header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 14px;
        }

        .breadcrumb {
            margin: 20px 0;
            font-size: 14px;
        }

        .breadcrumb a {
            color: #2c5f2d;
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .tab-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .tab-nav {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-btn {
            flex: 1;
            padding: 15px 20px;
            background: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .tab-btn:hover {
            background: #f9f9f9;
            color: #2c5f2d;
        }

        .tab-btn.active {
            color: #2c5f2d;
            border-bottom-color: #2c5f2d;
            background: #f0f7f0;
        }

        .tab-content {
            padding: 20px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒï¿½E */
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-label {
            font-weight: 500;
            color: #333;
        }

        .filter-select, .filter-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 14px;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #2c5f2d;
            box-shadow: 0 0 4px rgba(44, 95, 45, 0.3);
        }

        .filter-btn {
            padding: 8px 20px;
            border: 2px solid #2c5f2d;
            background: white;
            color: #2c5f2d;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Noto Sans JP', sans-serif;
            font-weight: 500;
            font-size: 14px;
        }

        .filter-btn:hover {
            background: #e8f5e9;
        }

        .filter-btn.active {
            background: #2c5f2d;
            color: white;
        }

        /* çµ±è¨ˆæƒ…å ± */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #2c5f2d;
        }

        .stat-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #2c5f2d;
            margin-top: 5px;
        }

        /* æ³¨æ–Eï¿½ï¿½ãƒ¼ãƒE*/
        .order-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .order-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .order-id {
            font-size: 18px;
            font-weight: bold;
            color: #2c5f2d;
        }

        .order-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-shipped {
            background: #d4edda;
            color: #155724;
        }

        .status-notified {
            background: #cfe2ff;
            color: #084298;
        }

        .order-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .info-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .info-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 3px;
            text-transform: uppercase;
        }

        .info-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .info-value.email {
            color: #0066cc;
            word-break: break-all;
        }

        /* å•Eï¿½ï¿½ãƒªã‚¹ãƒE*/
        .items-list {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #2c5f2d;
        }

        .items-list h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
        }

        .item {
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
        }

        .item:last-child {
            border-bottom: none;
        }

        .item-qty {
            color: #999;
        }

        /* é€šçŸ¥ãƒ•ã‚©ãƒ¼ãƒ  */
        .notification-form {
            margin-top: 20px;
            padding: 20px;
            background: #e8f5e9;
            border-radius: 8px;
            border: 1px solid #c8e6c9;
        }

        .notification-form h3 {
            margin: 0 0 15px 0;
            color: #2c5f2d;
            font-size: 14px;
        }

        .form-row {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
            font-size: 13px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #2c5f2d;
            box-shadow: 0 0 4px rgba(44, 95, 45, 0.3);
        }

        .form-row-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .btn-primary {
            background: #2c5f2d;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #1e4620;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(44, 95, 45, 0.3);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e8e8e8;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* é€šçŸ¥çŠ¶æ…E*/
        .notification-status {
            margin-top: 12px;
            padding: 12px;
            border-radius: 5px;
            font-size: 13px;
            display: none;
        }

        .notification-status.show {
            display: block;
        }

        .notification-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .notification-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .notification-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .notification-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* é¡§å®¢æƒEï¿½ï¿½ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .customer-info {
            background: #f0f7f0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2c5f2d;
            margin-bottom: 15px;
        }

        .customer-info h4 {
            margin: 0 0 10px 0;
            color: #2c5f2d;
            font-size: 13px;
        }

        .customer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .customer-field {
            font-size: 12px;
        }

        .customer-field-label {
            color: #999;
            margin-bottom: 2px;
        }

        .customer-field-value {
            color: #333;
            font-weight: 500;
        }

        /* ç©ºçŠ¶æ…E*/
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        /* åŒæœŸçŠ¶æ…E*/
        .sync-status {
            text-align: right;
            font-size: 12px;
            color: #999;
            margin-top: 10px;
        }

        .sync-status.syncing {
            color: #0066cc;
        }

        .sync-btn {
            margin-left: 10px;
            padding: 4px 12px;
            font-size: 12px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .sync-btn:hover {
            background: #e8e8e8;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿E*/
        @media (max-width: 768px) {
            .order-info {
                grid-template-columns: 1fr;
            }

            .form-row-group {
                grid-template-columns: 1fr;
            }

            .tab-btn {
                font-size: 12px;
                padding: 12px 15px;
            }

            .admin-header h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="breadcrumb">
            <a href="admin.html">â†Eç®¡çEï¿½ï¿½é¢ãƒˆãƒƒãƒE/a>
        </div>

        <div class="admin-header">
            <h1>ğŸ“§ ç™ºé€å®ŒäºEï¿½ï¿½çŸ¥ç®¡çE/h1>
            <p>é¡§å®¢ã¸ã®ç™ºé€å®ŒäºEï¿½ï¿½çŸ¥ã‚’ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã€‚å—æ³¨ç™ºæ³¨ç®¡çEï¿½ï¿½ãƒ—ãƒªã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€£æº</p>
            <div class="sync-status">
                æœ€çµ‚åŒæœE <span id="syncTime">---</span>
                <button class="sync-btn" onclick="forceSyncData()">ğŸ”„ å¼·åˆ¶åŒæœŸ</button>
            </div>
        </div>

        <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="tab-container">
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('pending')">ğŸ“¦ ç™ºé€å¾Eï¿½ï¿½ (<span id="pendingCount">0</span>)</button>
                <button class="tab-btn" onclick="switchTab('shipped')">âœEé€šçŸ¥æ¸ˆã¿ (<span id="shippedCount">0</span>)</button>
                <button class="tab-btn" onclick="switchTab('all')">ğŸ“‹ ã™ã¹ã¦ã®æ³¨æ–E/button>
            </div>

            <!-- ç™ºé€å¾Eï¿½ï¿½ã‚¿ãƒE-->
            <div id="pending-tab" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">ç™ºé€å¾Eï¿½ï¿½ä»¶æ•°</div>
                        <div class="stat-value"><span id="stat-pending">0</span>ä»¶</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ç™ºé€å¾Eï¿½ï¿½é‡‘é¡E/div>
                        <div class="stat-value">Â¥<span id="stat-pending-total">0</span></div>
                    </div>
                </div>

                <div class="filter-bar">
                    <div class="filter-group">
                        <label class="filter-label">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</label>
                        <select class="filter-select" id="customerFilter" onchange="filterOrders()">
                            <option value="">ã™ã¹ã¦ã®é¡§å®¢</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <input type="date" class="filter-input" id="dateFilter" onchange="filterOrders()">
                    </div>
                    <button class="filter-btn" onclick="clearFilters()">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªã‚¢</button>
                </div>

                <div id="pending-orders"></div>
            </div>

            <!-- é€šçŸ¥æ¸ˆã¿ã‚¿ãƒE-->
            <div id="shipped-tab" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">é€šçŸ¥æ¸ˆã¿ä»¶æ•°</div>
                        <div class="stat-value"><span id="stat-shipped">0</span>ä»¶</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">é€šçŸ¥æ¸ˆã¿é‡‘é¡E/div>
                        <div class="stat-value">Â¥<span id="stat-shipped-total">0</span></div>
                    </div>
                </div>

                <div id="shipped-orders"></div>
            </div>

            <!-- ã™ã¹ã¦ã®æ³¨æ–Eï¿½ï¿½ãƒE-->
            <div id="all-tab" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">ç·æ³¨æ–Eï¿½ï¿½æ•°</div>
                        <div class="stat-value"><span id="stat-all">0</span>ä»¶</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ç·å£²ä¸E/div>
                        <div class="stat-value">Â¥<span id="stat-all-total">0</span></div>
                    </div>
                </div>

                <div id="all-orders"></div>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let allOrders = [];
        let filteredOrders = [];
        let currentTab = 'pending';
        let notificationManager = null;

        // åˆæœŸåŒE
        document.addEventListener('DOMContentLoaded', function() {
            // ç®¡çEï¿½ï¿½Eï¿½ï¿½è¨¼ãƒã‚§ãƒEï¿½ï¿½
            if (!window.AdminNotificationManager.isAdminAuthenticated()) {
                window.location.href = 'admin-login.html';
                return;
            }
            
            initNotificationManager();
            loadAndDisplayOrders();
            updateSyncTime();

            // å®šæœŸçšEï¿½ï¿½åŒæœŸï¿½Eï¿½EåˆEï¿½ï¿½ã¨ï¿½Eï¿½E
            setInterval(loadAndDisplayOrders, 5 * 60 * 1000);
        });

        // é€šçŸ¥ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®åˆæœŸåŒE
        function initNotificationManager() {
            try {
                if (window.NotificationSystem) {
                    notificationManager = window.NotificationSystem.initialize({
                        provider: 'sendgrid',
                        fromEmail: 'tanabe@asakanatural.jp',
                        fromName: 'å®‰ç©ï¿½Eç„¶è¾²åœE
                    });
                } else {
                    console.warn('é€šçŸ¥ã‚·ã‚¹ãƒEï¿½ï¿½ãŒåˆ©ç”¨ä¸å¯');
                }
            } catch (error) {
                console.error('é€šçŸ¥ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // æ³¨æ–Eï¿½ï¿½ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¿½Eï¿½Eï¿½ï¿½ç¤º
        function loadAndDisplayOrders() {
            try {
                // å—æ³¨ç™ºæ³¨ç®¡çEï¿½ï¿½ãƒ—ãƒªã‹ã‚‰ãƒEï¿½Eã‚¿ã‚’åŒæœE
                const syncData = window.OrderSyncManager.syncFromOrdersApp();
                
                // æ³¨æ–Eï¿½ï¿½ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦æ•´å½¢
                allOrders = (syncData.orders || [])
                    .map(order => window.OrderSyncManager.formatOrderForAdmin(order))
                    .sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));

                // é¡§å®¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ›´æ–°
                updateCustomerFilter(syncData.customers || []);

                // çµ±è¨ˆã‚’è¨ˆç®E
                updateStats();

                // è¡¨ç¤ºã‚’æ›´æ–°
                renderCurrentTab();

                updateSyncTime();

            } catch (error) {
                console.error('æ³¨æ–Eï¿½ï¿½ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('ãƒEï¿½Eã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // é¡§å®¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ›´æ–°
        function updateCustomerFilter(customers) {
            const select = document.getElementById('customerFilter');
            const currentValue = select.value;

            // æ—¢å­˜ï¿½Eã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ï¿½Eï¿½æœ€åˆï¿½Eã‚ªãƒ—ã‚·ãƒ§ãƒ³é™¤ãï¼E
            while (select.options.length > 1) {
                select.remove(1);
            }

            // é¡§å®¢ãƒªã‚¹ãƒˆã‚’è¿½åŠ 
            customers.forEach(customer => {
                const option = new Option(customer.name, customer.id);
                select.add(option);
            });

            // å‰ï¿½Eå€¤ã‚’å¾©å…E
            if (currentValue) {
                select.value = currentValue;
            }
        }

        // çµ±è¨ˆã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º
        function updateStats() {
            const pending = allOrders.filter(o => o.status === 'pending' || o.status === 'processing' || o.status === 'confirmed');
            const shipped = allOrders.filter(o => o.status === 'shipped');

            const pendingTotal = pending.reduce((sum, o) => sum + o.total, 0);
            const shippedTotal = shipped.reduce((sum, o) => sum + o.total, 0);
            const allTotal = allOrders.reduce((sum, o) => sum + o.total, 0);

            // ç™ºé€å¾Eï¿½ï¿½ã‚¿ãƒE
            document.getElementById('stat-pending').textContent = pending.length;
            document.getElementById('stat-pending-total').textContent = pendingTotal.toLocaleString('ja-JP');
            document.getElementById('pendingCount').textContent = pending.length;

            // é€šçŸ¥æ¸ˆã¿ã‚¿ãƒE
            document.getElementById('stat-shipped').textContent = shipped.length;
            document.getElementById('stat-shipped-total').textContent = shippedTotal.toLocaleString('ja-JP');
            document.getElementById('shippedCount').textContent = shipped.length;

            // ã™ã¹ã¦ã®ã‚¿ãƒE
            document.getElementById('stat-all').textContent = allOrders.length;
            document.getElementById('stat-all-total').textContent = allTotal.toLocaleString('ja-JP');
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
        function filterOrders() {
            const customerFilter = document.getElementById('customerFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;

            filteredOrders = allOrders.filter(order => {
                if (customerFilter && !order.items.some(i => i.customerId === customerFilter)) {
                    // é¡§å®¢IDã§ç›´æ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                    if (!order.customerEmail) return false;
                }
                if (dateFilter && order.orderDate !== dateFilter) {
                    return false;
                }
                return true;
            });

            if (customerFilter) {
                filteredOrders = filteredOrders.filter(order => {
                    // é¡§å®¢æƒEï¿½ï¿½ã‚’ç¢ºèªE
                    const customer = window.OrderSyncManager.getCustomerById(order.id);
                    return customer?.id === customerFilter;
                });
            }

            renderCurrentTab();
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è§£é™¤
        function clearFilters() {
            document.getElementById('customerFilter').value = '';
            document.getElementById('dateFilter').value = '';
            filteredOrders = [];
            renderCurrentTab();
        }

        // ã‚¿ãƒ–ï¿½Eã‚Šæ›¿ãE
        function switchTab(tabName) {
            currentTab = tabName;

            // ã‚¿ãƒ–ï¿½Eã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒEï¿½ï¿½ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // ã‚¿ãƒ–ã‚³ãƒ³ãƒEï¿½ï¿½ãƒEï¿½Eè¡¨ç¤º/éè¡¨ç¤ºã‚’æ›´æ–°
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');

            renderCurrentTab();
        }

        // ç¾åœ¨ã®ã‚¿ãƒ–ã‚’æç”»
        function renderCurrentTab() {
            let ordersToShow = filteredOrders.length > 0 ? filteredOrders : allOrders;

            // ã‚¿ãƒ–ã”ã¨ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            if (currentTab === 'pending') {
                ordersToShow = ordersToShow.filter(o => o.status !== 'shipped');
            } else if (currentTab === 'shipped') {
                ordersToShow = ordersToShow.filter(o => o.status === 'shipped');
            }

            const containerId = currentTab + '-orders';
            const container = document.getElementById(containerId);

            if (ordersToShow.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <p>è©²å½“ã™ã‚‹æ³¨æ–Eï¿½ï¿½ã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = ordersToShow.map(order => createOrderCard(order)).join('');
        }

        // æ³¨æ–Eï¿½ï¿½ãƒ¼ãƒ‰ã‚’ä½œï¿½E
        function createOrderCard(order) {
            const statusClass = order.status === 'shipped' ? 'status-shipped' : 'status-pending';
            const statusLabel = order.status === 'shipped' ? 'é€šçŸ¥æ¸ˆã¿' : 'ç™ºé€å¾Eï¿½ï¿½';

            // é¡§å®¢æƒEï¿½ï¿½ã‚’å–å¾E
            const customerInfo = window.OrderSyncManager.getCustomerById(order.id.split('_')[0]) || {};

            // ç™ºé€ãƒ•ã‚©ãƒ¼ãƒ éƒ¨åˆE
            const shippingForm = (order.status === 'pending' || order.status === 'processing' || order.status === 'confirmed') ? `
                <div class="notification-form">
                    <h3>ğŸ“§ ç™ºé€å®ŒäºEï¿½ï¿½çŸ¥ã‚’é€ä¿¡</h3>
                    <div class="form-row">
                        <label class="form-label">é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="email" 
                               class="form-input" 
                               id="email_${order.id}" 
                               value="${order.customerEmail}"
                               readonly>
                    </div>
                    <div class="form-row-group">
                        <div>
                            <label class="form-label">é…é€æ¥­è€E/label>
                            <select class="form-select" id="carrier_${order.id}">
                                <option value="ãƒ¤ãƒãƒˆé‹è¼¸">ãƒ¤ãƒãƒˆé‹è¼¸</option>
                                <option value="æ—¥æœ¬éƒµä¾¿">æ—¥æœ¬éƒµä¾¿</option>
                                <option value="ä½å·æ€¥ä¾¿">ä½å·æ€¥ä¾¿</option>
                                <option value="ãï¿½Eä»E>ãï¿½Eä»E/option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">è¿½è·¡ç•ªå·</label>
                            <input type="text" 
                                   class="form-input" 
                                   id="tracking_${order.id}" 
                                   placeholder="ä¾E 1234567890123">
                        </div>
                    </div>
                    <div class="form-row-group">
                        <div>
                            <label class="form-label">ç™ºé€æ—¥</label>
                            <input type="date" 
                                   class="form-input" 
                                   id="shipdate_${order.id}" 
                                   value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div>
                            <label class="form-label">åˆ°ç€äºˆå®šæ—¥</label>
                            <input type="date" 
                                   class="form-input" 
                                   id="deliverydate_${order.id}" 
                                   value="${getEstimatedDeliveryDate()}">
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="sendShippingNotification('${order.id}')">
                            ğŸ“§ é€šçŸ¥ã‚’é€ä¿¡
                        </button>
                        <button class="btn btn-secondary" onclick="openOrderDetail('${order.id}')">
                            è©³ç´°è¡¨ç¤º
                        </button>
                    </div>
                    <div id="notification_${order.id}" class="notification-status"></div>
                </div>
            ` : '';

            // ç™ºé€æ¸ˆã¿æƒEï¿½ï¿½
            const shippedInfo = order.status === 'shipped' ? `
                <div style="padding:15px;background:#d4edda;border-radius:5px;margin-top:15px;border-left:4px solid #28a745;">
                    <strong>âœEé€šçŸ¥æ¸ˆã¿</strong><br>
                    <small>ç™ºé€æ—¥: ${order.shippedDate || '---'} | è¿½è·¡ç•ªå·: ${order.trackingNumber || '---'}</small>
                </div>
            ` : '';

            return `
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-id">${order.id}</div>
                        <div class="order-status ${statusClass}">${statusLabel}</div>
                    </div>

                    <!-- é¡§å®¢æƒEï¿½ï¿½ -->
                    <div class="customer-info">
                        <h4>ğŸ‘¤ é¡§å®¢æƒEï¿½ï¿½</h4>
                        <div class="customer-grid">
                            <div class="customer-field">
                                <div class="customer-field-label">é¡§å®¢åE/div>
                                <div class="customer-field-value">${order.customerName}</div>
                            </div>
                            <div class="customer-field">
                                <div class="customer-field-label">ãƒ¡ãƒ¼ãƒ«</div>
                                <div class="customer-field-value email">${order.customerEmail}</div>
                            </div>
                            <div class="customer-field">
                                <div class="customer-field-label">é›»è©±</div>
                                <div class="customer-field-value">${order.customerPhone || 'æœªç™»éŒ²'}</div>
                            </div>
                            <div class="customer-field">
                                <div class="customer-field-label">æ³¨æ–Eï¿½ï¿½</div>
                                <div class="customer-field-value">${order.orderDate}</div>
                            </div>
                        </div>
                    </div>

                    <!-- æ³¨æ–Eï¿½ï¿½å ± -->
                    <div class="order-info">
                        <div class="info-item">
                            <div class="info-label">ãŠæ”¯æ‰•ã„æ–¹æ³E/div>
                            <div class="info-value">${order.paymentMethod}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">åˆè¨ˆï¿½ï¿½é¡E/div>
                            <div class="info-value">Â¥${order.total.toLocaleString('ja-JP')}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">é…é€ï¿½Eä½æ‰€</div>
                            <div class="info-value">${order.shippingAddress}</div>
                        </div>
                    </div>

                    <!-- æ³¨æ–Eï¿½Eå®¹ -->
                    <div class="items-list">
                        <h4>ğŸ“¦ æ³¨æ–Eï¿½Eå®¹</h4>
                        ${order.items.map(item => `
                            <div class="item">
                                <span>${item.name || 'å•Eï¿½ï¿½'}</span>
                                <span class="item-qty">ÃE${item.quantity}</span>
                            </div>
                        `).join('')}
                    </div>

                    ${shippedInfo}
                    ${shippingForm}
                </div>
            `;
        }

        // åˆ°ç€äºˆå®šæ—¥ã‚’è¨ˆç®E
        function getEstimatedDeliveryDate() {
            const date = new Date();
            date.setDate(date.getDate() + 2);
            return date.toISOString().split('T')[0];
        }

        // ç™ºé€å®ŒäºEï¿½ï¿½çŸ¥ã‚’é€ä¿¡
        async function sendShippingNotification(orderId) {
            const trackingInput = document.getElementById(`tracking_${orderId}`);
            const carrierSelect = document.getElementById(`carrier_${orderId}`);
            const shipdateInput = document.getElementById(`shipdate_${orderId}`);
            const deliverydateInput = document.getElementById(`deliverydate_${orderId}`);
            const notificationDiv = document.getElementById(`notification_${orderId}`);
            const button = event.target;

            const trackingNumber = trackingInput.value.trim();
            const carrier = carrierSelect.value;
            const shippedDate = shipdateInput.value;
            const estimatedDeliveryDate = deliverydateInput.value;

            // ãƒãƒªãƒEï¿½Eã‚·ãƒ§ãƒ³
            if (!trackingNumber) {
                showNotificationInCard(notificationDiv, 'è¿½è·¡ç•ªå·ã‚’ï¿½EåŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            button.disabled = true;
            button.textContent = 'é€ä¿¡ä¸­...';
            showNotificationInCard(notificationDiv, 'ğŸ“§ ç™ºé€å®ŒäºEï¿½ï¿½çŸ¥ã‚’é€ä¿¡ã—ã¦ãEï¿½ï¿½ãE..', 'info');

            try {
                const order = allOrders.find(o => o.id === orderId);
                if (!order) {
                    throw new Error('æ³¨æ–Eï¿½ï¿½ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }

                // é€ä¿¡ãƒEï¿½Eã‚¿ã‚’æº–å‚™
                const emailData = {
                    orderId: order.id,
                    customerEmail: order.customerEmail,
                    customerName: order.customerName,
                    trackingNumber: trackingNumber,
                    carrier: carrier,
                    shippedDate: shippedDate,
                    estimatedDeliveryDate: estimatedDeliveryDate,
                    items: order.items
                };

                // ç®¡çEï¿½ï¿½Eï¿½ï¿½ãƒ¼ãƒ«é€ä¿¡
                if (notificationManager && notificationManager.sendShippingNotification) {
                    await notificationManager.sendShippingNotification(emailData);
                } else {
                    console.log('é€šçŸ¥é€ä¿¡:', emailData);
                }

                // æ³¨æ–Eï¿½ï¿½ãƒEï¿½Eã‚¿ã‚¹ã‚’æ›´æ–°
                order.status = 'shipped';
                order.trackingNumber = trackingNumber;
                order.shippedDate = shippedDate;

                // é€ä¿¡å±¥æ­´ã‚’è¨˜éŒ²
                if (window.EmailHistoryManager) {
                    window.EmailHistoryManager.recordEmailSent({
                        ...emailData,
                        sentBy: 'ç®¡çEï¿½ï¿½E
                    });
                }

                showNotificationInCard(
                    notificationDiv, 
                    `âœEç™ºé€å®ŒäºEï¿½ï¿½çŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ<br><small>${order.customerEmail} ã¸é€ä¿¡<br>è¿½è·¡ç•ªå·: ${trackingNumber}</small>`, 
                    'success'
                );

                // 2ç§’å¾Œã«ç”»é¢æ›´æ–°
                setTimeout(() => {
                    updateStats();
                    renderCurrentTab();
                }, 2000);

            } catch (error) {
                console.error('é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                
                // ã‚¨ãƒ©ãƒ¼ã‚’å±¥æ­´ã«è¨˜éŒ²
                const order = allOrders.find(o => o.id === orderId);
                if (order && window.EmailHistoryManager) {
                    window.EmailHistoryManager.recordEmailError({
                        orderId: order.id,
                        customerEmail: order.customerEmail,
                        customerName: order.customerName,
                        carrier: carrier,
                        trackingNumber: trackingNumber
                    }, error.message);
                }
                
                showNotificationInCard(
                    notificationDiv,
                    `âœEã‚¨ãƒ©ãƒ¼: ${error.message}`,
                    'error'
                );
                button.disabled = false;
                button.textContent = 'ğŸ“§ é€šçŸ¥ã‚’é€ä¿¡';
            }
        }

        // ã‚«ãƒ¼ãƒ‰ï¿½Eã®é€šçŸ¥ã‚’è¡¨ç¤º
        function showNotificationInCard(element, message, type) {
            element.innerHTML = `<div class="notification-status show notification-${type}">${message}</div>`;
        }

        // ãƒšï¿½Eã‚¸ã®é€šçŸ¥ã‚’è¡¨ç¤ºï¿½Eï¿½æœªä½¿ç”¨éƒ¨åˆEï¿½ï¿½ï¿½Eï¿½E
        function showNotification(message, type = 'info') {
            console.log(`[${type}] ${message}`);
            // å®Ÿè£Eï¿½ï¿½ã‚ã‚‹å ´åˆï¿½Eã“ã“ã«è¿½åŠ 
        }

        // è©³ç´°è¡¨ç¤ºï¿½Eï¿½æ‹¡å¼µå¯èƒ½ï¿½Eï¿½E
        function openOrderDetail(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (order) {
                alert(`æ³¨æ–Eï¿½ï¿½ç´°: ${order.id}\né¡§å®¢: ${order.customerName}\nãƒ¡ãƒ¼ãƒ«: ${order.customerEmail}`);
            }
        }

        // å¼·åˆ¶åŒæœŸ
        function forceSyncData() {
            if (window.OrderSyncManager) {
                window.OrderSyncManager.clearCache();
                loadAndDisplayOrders();
                alert('ãƒEï¿½Eã‚¿ã‚’åŒæœŸã—ã¾ã—ãŸ');
            }
        }

        // åŒæœŸæ™‚é–“ã‚’æ›´æ–°
        function updateSyncTime() {
            const lastSync = window.OrderSyncManager.getLastSyncTime();
            document.getElementById('syncTime').textContent = lastSync || 'æœªåŒæœŸ';
        }
    </script>
</body>
</html>
