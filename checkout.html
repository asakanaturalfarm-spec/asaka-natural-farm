<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="å®‰ç©ç›´å£²æ‰€ ãƒ¬ã‚¸ãƒ»ãŠæ”¯æ‰•ã„">
    <title>ãƒ¬ã‚¸ | å®‰ç©ç›´å£²æ‰€</title>
    <link rel="stylesheet" href="style.css?v=3">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@500;700&family=Noto+Sans+JP:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="script.js"></script>
    <script src="auth.js"></script>
    <script src="inventory-sync.js"></script>
    <script src="order-sync.js"></script>
    <script src="shipping-calculator.js"></script>
    <script src="notification-system.js"></script>
    <script src="payment-integration.js"></script>
    <script src="system-integration.js"></script>
    <script>
        // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
        window.addEventListener('DOMContentLoaded', () => {
            if (!window.Auth || !window.Auth.isLoggedIn()) {
                alert('ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚');
                window.location.href = 'login.html?redirect=checkout.html';
                return;
            }
        });
    </script>
    <style>
        .checkout-page {
            min-height: 100vh;
            background: var(--bg-cream);
            padding: 100px 40px;
        }

        .checkout-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .checkout-header {
            text-align: center;
            margin-bottom: 60px;
        }

        .checkout-header h1 {
            font-size: 40px;
            color: var(--text-dark);
            font-family: 'Noto Serif JP', serif;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .checkout-steps {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 60px;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .step-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--border-medium);
            color: var(--text-medium);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
        }

        .step.active .step-number {
            background: var(--primary-color);
            color: white;
        }

        .step.completed .step-number {
            background: var(--accent-gold);
            color: white;
        }

        .step-label {
            font-size: 15px;
            color: var(--text-medium);
        }

        .step.active .step-label {
            color: var(--text-dark);
            font-weight: 600;
        }

        .checkout-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 40px;
        }

        .checkout-form {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: var(--shadow-sm);
        }

        .form-section {
            margin-bottom: 40px;
            padding-bottom: 40px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .section-title {
            font-size: 22px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 24px;
            font-family: 'Noto Serif JP', serif;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .required {
            color: #dc3545;
            margin-left: 4px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid var(--border-medium);
            border-radius: 8px;
            font-size: 15px;
            font-family: 'Noto Sans JP', sans-serif;
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(61, 90, 61, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .payment-methods {
            display: grid;
            gap: 12px;
        }

        .payment-option {
            display: flex;
            align-items: center;
            padding: 16px;
            border: 2px solid var(--border-medium);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .payment-option:hover {
            border-color: var(--primary-color);
        }

        .payment-option input[type="radio"] {
            margin-right: 12px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .payment-option.selected {
            border-color: var(--primary-color);
            background: rgba(61, 90, 61, 0.05);
        }

        .payment-label {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .payment-icon {
            font-size: 24px;
        }

        .payment-info {
            flex: 1;
        }

        .payment-name {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 15px;
        }

        .payment-desc {
            font-size: 13px;
            color: var(--text-light);
            margin-top: 2px;
        }

        .order-summary {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: var(--shadow-sm);
            height: fit-content;
            position: sticky;
            top: 120px;
        }

        .summary-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 24px;
            font-family: 'Noto Serif JP', serif;
        }

        .order-items {
            margin-bottom: 24px;
        }

        .order-item {
            display: flex;
            gap: 16px;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .order-item:first-child {
            padding-top: 0;
        }

        .order-item-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-cream);
            flex-shrink: 0;
        }

        .order-item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .order-item-details {
            flex: 1;
        }

        .order-item-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .order-item-quantity {
            font-size: 13px;
            color: var(--text-light);
        }

        .order-item-price {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-dark);
            text-align: right;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .summary-row:last-of-type {
            border-bottom: 2px solid var(--border-medium);
            margin-bottom: 16px;
        }

        .summary-label {
            color: var(--text-medium);
            font-size: 15px;
        }

        .summary-value {
            color: var(--text-dark);
            font-weight: 600;
            font-size: 15px;
        }

        .summary-total {
            display: flex;
            justify-content: space-between;
            padding: 16px 0;
            margin-bottom: 32px;
        }

        .summary-total .summary-label {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .summary-total .summary-value {
            font-size: 24px;
            color: var(--primary-color);
        }

        .place-order-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 16px;
        }

        .place-order-btn:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .place-order-btn:disabled {
            background: var(--border-medium);
            cursor: not-allowed;
        }

        .back-to-cart {
            text-align: center;
        }

        .back-to-cart a {
            color: var(--text-medium);
            font-size: 14px;
            text-decoration: none;
        }

        .back-to-cart a:hover {
            color: var(--primary-color);
        }

        .secure-notice {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: rgba(61, 90, 61, 0.05);
            border-radius: 8px;
            font-size: 13px;
            color: var(--text-medium);
            margin-top: 16px;
        }

        .secure-icon {
            color: var(--primary-color);
        }

        @media (max-width: 768px) {
            .checkout-page {
                padding: 60px 20px;
            }

            .checkout-steps {
                gap: 20px;
                flex-wrap: wrap;
            }

            .step {
                flex: 1;
                min-width: 120px;
            }

            .checkout-content {
                grid-template-columns: 1fr;
            }

            .checkout-form {
                padding: 24px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .order-summary {
                position: static;
            }
        }
    </style>
</head>
<body>
    <div class="checkout-page">
        <div class="checkout-container">
            <div class="checkout-header">
                <h1>ãƒ¬ã‚¸</h1>
                
                <div class="checkout-steps">
                    <div class="step completed">
                        <div class="step-number">1</div>
                        <div class="step-label">ã‚«ãƒ¼ãƒˆ</div>
                    </div>
                    <div class="step active">
                        <div class="step-number">2</div>
                        <div class="step-label">é…é€ãƒ»æ”¯æ‰•ã„</div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-label">æ³¨æ–‡å®Œäº†</div>
                    </div>
                </div>
            </div>

            <!-- ãƒ˜ãƒ«ãƒ—ãƒœãƒƒã‚¯ã‚¹ -->
            <div style="background: #e8f5e9; border-left: 4px solid #2c5f2d; padding: 15px; margin-bottom: 30px; border-radius: 5px;">
                <p style="margin: 0; font-size: 14px; color: #333;">
                    <strong>ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã™ã‹ï¼Ÿ</strong>
                    <a href="faq.html" style="color: #2c5f2d; margin-left: 10px;">ã‚ˆãã‚ã‚‹è³ªå•</a> ï½œ
                    <a href="contact.html" style="color: #2c5f2d; margin-left: 10px;">ãŠå•ã„åˆã‚ã›</a>
                </p>
            </div>

            <div class="checkout-content">
                <div class="checkout-form">
                    <form id="checkoutForm">
                        <!-- é…é€å…ˆæƒ…å ± -->
                        <div class="form-section">
                            <h2 class="section-title">é…é€å…ˆæƒ…å ±</h2>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>å§“<span class="required">*</span></label>
                                    <input type="text" name="lastName" required minlength="1" maxlength="50" id="lastName">
                                    <small class="validation-error" style="color: #dc3545; font-size: 12px; display: none;" id="lastNameError">å§“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</small>
                                </div>
                                <div class="form-group">
                                    <label>å<span class="required">*</span></label>
                                    <input type="text" name="firstName" required minlength="1" maxlength="50" id="firstName">
                                    <small class="validation-error" style="color: #dc3545; font-size: 12px; display: none;" id="firstNameError">åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</small>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹<span class="required">*</span></label>
                                <input type="email" name="email" required id="email">
                                <small class="validation-error" style="color: #dc3545; font-size: 12px; display: none;" id="emailError">æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</small>
                            </div>

                            <div class="form-group">
                                <label>é›»è©±ç•ªå·<span class="required">*</span></label>
                                <input type="tel" name="phone" placeholder="090-1234-5678" required pattern="^0\d{1,4}-?\d{1,4}-?\d{4}$" id="phone">
                                <small class="validation-error" style="color: #dc3545; font-size: 12px; display: none;" id="phoneError">é›»è©±ç•ªå·ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ï¼ˆä¾‹: 090-1234-5678ï¼‰</small>
                            </div>

                            <div class="form-group">
                                <label>éƒµä¾¿ç•ªå·<span class="required">*</span></label>
                                <input type="text" name="postalCode" placeholder="123-4567" required pattern="^\d{3}-?\d{4}$" id="postalCode">
                                <small class="validation-error" style="color: #dc3545; font-size: 12px; display: none;" id="postalCodeError">éƒµä¾¿ç•ªå·ã¯ã€Œ123-4567ã€ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„</small>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>éƒ½é“åºœçœŒ<span class="required">*</span></label>
                                    <select name="prefecture" required id="prefecture">
                                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                        <option value="åŒ—æµ·é“">åŒ—æµ·é“</option>
                                        <option value="é’æ£®çœŒ">é’æ£®çœŒ</option>
                                        <option value="å²©æ‰‹çœŒ">å²©æ‰‹çœŒ</option>
                                        <option value="å®®åŸçœŒ">å®®åŸçœŒ</option>
                                        <option value="ç§‹ç”°çœŒ">ç§‹ç”°çœŒ</option>
                                        <option value="å±±å½¢çœŒ">å±±å½¢çœŒ</option>
                                        <option value="ç¦å³¶çœŒ">ç¦å³¶çœŒ</option>
                                        <option value="èŒ¨åŸçœŒ">èŒ¨åŸçœŒ</option>
                                        <option value="æ ƒæœ¨çœŒ">æ ƒæœ¨çœŒ</option>
                                        <option value="ç¾¤é¦¬çœŒ">ç¾¤é¦¬çœŒ</option>
                                        <option value="åŸ¼ç‰çœŒ">åŸ¼ç‰çœŒ</option>
                                        <option value="åƒè‘‰çœŒ">åƒè‘‰çœŒ</option>
                                        <option value="æ±äº¬éƒ½">æ±äº¬éƒ½</option>
                                        <option value="ç¥å¥ˆå·çœŒ">ç¥å¥ˆå·çœŒ</option>
                                        <option value="æ–°æ½ŸçœŒ">æ–°æ½ŸçœŒ</option>
                                        <option value="å¯Œå±±çœŒ">å¯Œå±±çœŒ</option>
                                        <option value="çŸ³å·çœŒ">çŸ³å·çœŒ</option>
                                        <option value="ç¦äº•çœŒ">ç¦äº•çœŒ</option>
                                        <option value="å±±æ¢¨çœŒ">å±±æ¢¨çœŒ</option>
                                        <option value="é•·é‡çœŒ">é•·é‡çœŒ</option>
                                        <option value="å²é˜œçœŒ">å²é˜œçœŒ</option>
                                        <option value="é™å²¡çœŒ">é™å²¡çœŒ</option>
                                        <option value="æ„›çŸ¥çœŒ">æ„›çŸ¥çœŒ</option>
                                        <option value="ä¸‰é‡çœŒ">ä¸‰é‡çœŒ</option>
                                        <option value="æ»‹è³€çœŒ">æ»‹è³€çœŒ</option>
                                        <option value="äº¬éƒ½åºœ">äº¬éƒ½åºœ</option>
                                        <option value="å¤§é˜ªåºœ">å¤§é˜ªåºœ</option>
                                        <option value="å…µåº«çœŒ">å…µåº«çœŒ</option>
                                        <option value="å¥ˆè‰¯çœŒ">å¥ˆè‰¯çœŒ</option>
                                        <option value="å’Œæ­Œå±±çœŒ">å’Œæ­Œå±±çœŒ</option>
                                        <option value="é³¥å–çœŒ">é³¥å–çœŒ</option>
                                        <option value="å³¶æ ¹çœŒ">å³¶æ ¹çœŒ</option>
                                        <option value="å²¡å±±çœŒ">å²¡å±±çœŒ</option>
                                        <option value="åºƒå³¶çœŒ">åºƒå³¶çœŒ</option>
                                        <option value="å±±å£çœŒ">å±±å£çœŒ</option>
                                        <option value="å¾³å³¶çœŒ">å¾³å³¶çœŒ</option>
                                        <option value="é¦™å·çœŒ">é¦™å·çœŒ</option>
                                        <option value="æ„›åª›çœŒ">æ„›åª›çœŒ</option>
                                        <option value="é«˜çŸ¥çœŒ">é«˜çŸ¥çœŒ</option>
                                        <option value="ç¦å²¡çœŒ">ç¦å²¡çœŒ</option>
                                        <option value="ä½è³€çœŒ">ä½è³€çœŒ</option>
                                        <option value="é•·å´çœŒ">é•·å´çœŒ</option>
                                        <option value="ç†Šæœ¬çœŒ">ç†Šæœ¬çœŒ</option>
                                        <option value="å¤§åˆ†çœŒ">å¤§åˆ†çœŒ</option>
                                        <option value="å®®å´çœŒ">å®®å´çœŒ</option>
                                        <option value="é¹¿å…å³¶çœŒ">é¹¿å…å³¶çœŒ</option>
                                        <option value="æ²–ç¸„çœŒ">æ²–ç¸„çœŒ</option>
                                    </select>
                                    <small class="validation-error" style="color: #dc3545; font-size: 12px; display: none;" id="prefectureError">éƒ½é“åºœçœŒã‚’é¸æŠã—ã¦ãã ã•ã„</small>
                                </div>
                                <div class="form-group">
                                    <label>å¸‚åŒºç”ºæ‘<span class="required">*</span></label>
                                    <input type="text" name="city" required minlength="1" maxlength="100" id="city">
                                    <small class="validation-error" style="color: #dc3545; font-size: 12px; display: none;" id="cityError">å¸‚åŒºç”ºæ‘ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</small>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>ç•ªåœ°ãƒ»å»ºç‰©å<span class="required">*</span></label>
                                <input type="text" name="address" placeholder="ã€‡ã€‡ç”º1-2-3 ã€‡ã€‡ãƒãƒ³ã‚·ãƒ§ãƒ³101" required minlength="1" maxlength="200" id="address">
                                <small class="validation-error" style="color: #dc3545; font-size: 12px; display: none;" id="addressError">ç•ªåœ°ãƒ»å»ºç‰©åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</small>
                            </div>

                            <div class="form-group">
                                <label>é…é€ã«é–¢ã™ã‚‹ãƒ¡ãƒ¢</label>
                                <textarea name="deliveryNote" placeholder="é…é€æ™‚é–“ã®å¸Œæœ›ã‚„ç½®ãé…ãªã©"></textarea>
                            </div>
                        </div>

                        <!-- ãŠæ”¯æ‰•ã„æ–¹æ³• -->
                        <div class="form-section">
                            <h2 class="section-title">ãŠæ”¯æ‰•ã„æ–¹æ³•</h2>
                            
                            <div class="payment-methods">
                                <label class="payment-option selected">
                                    <input type="radio" name="paymentMethod" value="credit" checked>
                                    <div class="payment-label">
                                        <div class="payment-icon">ğŸ’³</div>
                                        <div class="payment-info">
                                            <div class="payment-name">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</div>
                                            <div class="payment-desc">Visa / Mastercard / JCB / AMEX</div>
                                        </div>
                                    </div>
                                </label>

                                <label class="payment-option">
                                    <input type="radio" name="paymentMethod" value="bank">
                                    <div class="payment-label">
                                        <div class="payment-icon">ğŸ¦</div>
                                        <div class="payment-info">
                                            <div class="payment-name">éŠ€è¡ŒæŒ¯è¾¼</div>
                                            <div class="payment-desc">æŒ¯è¾¼å…ˆã¯æ³¨æ–‡å¾Œã«ã”æ¡ˆå†…</div>
                                        </div>
                                    </div>
                                </label>

                                <label class="payment-option">
                                    <input type="radio" name="paymentMethod" value="cod">
                                    <div class="payment-label">
                                        <div class="payment-icon">ğŸ’°</div>
                                        <div class="payment-info">
                                            <div class="payment-name">ä»£é‡‘å¼•æ›</div>
                                            <div class="payment-desc">é…é”æ™‚ã«ç¾é‡‘ã§ãŠæ”¯æ‰•ã„ï¼ˆæ‰‹æ•°æ–™Â¥300ï¼‰</div>
                                        </div>
                                    </div>
                                </label>

                                <label class="payment-option">
                                    <input type="radio" name="paymentMethod" value="konbini">
                                    <div class="payment-label">
                                        <div class="payment-icon">ğŸª</div>
                                        <div class="payment-info">
                                            <div class="payment-name">ã‚³ãƒ³ãƒ“ãƒ‹æ±ºæ¸ˆ</div>
                                            <div class="payment-desc">ã‚»ãƒ–ãƒ³ / ãƒ­ãƒ¼ã‚½ãƒ³ / ãƒ•ã‚¡ãƒŸãƒ</div>
                                        </div>
                                    </div>
                                </label>
                            </div>

                            <!-- æ”¯æ‰•ã„æ–¹æ³•åˆ¥ã®è©³ç´°æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                            <div id="paymentDetails" style="margin-top: 24px; padding: 20px; background: #f8f9fa; border-radius: 8px; display: none;">
                                <div id="creditCardDetails" style="display: none;">
                                    <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰æƒ…å ±</h4>
                                    <p style="font-size: 14px; color: #666; margin-bottom: 12px;">æ³¨æ–‡ç¢ºå®šå¾Œã€æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã€‚å®‰å…¨ãªæš—å·åŒ–é€šä¿¡ã§ä¿è­·ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
                                    <ul style="font-size: 13px; color: #666; padding-left: 20px;">
                                        <li>Visaã€Mastercardã€JCBã€American Expresså¯¾å¿œ</li>
                                        <li>æ±ºæ¸ˆå®Œäº†å¾Œã€å³åº§ã«æ³¨æ–‡ãŒç¢ºå®šã—ã¾ã™</li>
                                    </ul>
                                </div>
                                <div id="bankTransferDetails" style="display: none;">
                                    <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">éŠ€è¡ŒæŒ¯è¾¼ã«ã¤ã„ã¦</h4>
                                    <p style="font-size: 14px; color: #666; margin-bottom: 12px;">ã”æ³¨æ–‡ç¢ºå®šå¾Œã€æŒ¯è¾¼å…ˆå£åº§æƒ…å ±ã‚’ãƒ¡ãƒ¼ãƒ«ã§ãŠé€ã‚Šã—ã¾ã™ã€‚</p>
                                    <ul style="font-size: 13px; color: #666; padding-left: 20px;">
                                        <li>ã”å…¥é‡‘ç¢ºèªå¾Œã€3å–¶æ¥­æ—¥ä»¥å†…ã«ç™ºé€ã—ã¾ã™</li>
                                        <li>æŒ¯è¾¼æ‰‹æ•°æ–™ã¯ãŠå®¢æ§˜è² æ‹…ã¨ãªã‚Šã¾ã™</li>
                                        <li>ã”æ³¨æ–‡ã‹ã‚‰7æ—¥ä»¥å†…ã«ãŠæŒ¯è¾¼ã¿ãã ã•ã„</li>
                                    </ul>
                                </div>
                                <div id="codDetails" style="display: none;">
                                    <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">ä»£é‡‘å¼•æ›ã«ã¤ã„ã¦</h4>
                                    <p style="font-size: 14px; color: #666; margin-bottom: 12px;">å•†å“å—å–æ™‚ã«é…é”å“¡ã¸ç¾é‡‘ã§ãŠæ”¯æ‰•ã„ãã ã•ã„ã€‚</p>
                                    <ul style="font-size: 13px; color: #666; padding-left: 20px;">
                                        <li>ä»£å¼•æ‰‹æ•°æ–™: Â¥300</li>
                                        <li>ãŠé‡£ã‚Šã®ãªã„ã‚ˆã†ã”æº–å‚™ã„ãŸã ã‘ã‚‹ã¨åŠ©ã‹ã‚Šã¾ã™</li>
                                        <li>é…é”æ™‚ã«ã”ä¸åœ¨ã®å ´åˆã€å†é…é”ã¨ãªã‚Šã¾ã™</li>
                                    </ul>
                                </div>
                                <div id="konbiniDetails" style="display: none;">
                                    <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">ã‚³ãƒ³ãƒ“ãƒ‹æ±ºæ¸ˆã«ã¤ã„ã¦</h4>
                                    <p style="font-size: 14px; color: #666; margin-bottom: 12px;">ã”æ³¨æ–‡ç¢ºå®šå¾Œã€ãŠæ”¯æ‰•ã„ç•ªå·ã‚’ãƒ¡ãƒ¼ãƒ«ã§ãŠé€ã‚Šã—ã¾ã™ã€‚</p>
                                    <ul style="font-size: 13px; color: #666; padding-left: 20px;">
                                        <li>å¯¾å¿œåº—èˆ—: ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³ã€ãƒ­ãƒ¼ã‚½ãƒ³ã€ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒãƒ¼ãƒˆ</li>
                                        <li>ãŠæ”¯æ‰•ã„ç¢ºèªå¾Œã€3å–¶æ¥­æ—¥ä»¥å†…ã«ç™ºé€ã—ã¾ã™</li>
                                        <li>ã”æ³¨æ–‡ã‹ã‚‰7æ—¥ä»¥å†…ã«ãŠæ”¯æ‰•ã„ãã ã•ã„</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="order-summary">
                    <h3 class="summary-title">æ³¨æ–‡å†…å®¹</h3>
                    
                    <div class="order-items" id="orderItems">
                        <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                    
                    <div class="summary-row">
                        <span class="summary-label">å°è¨ˆ</span>
                        <span class="summary-value" id="subtotalAmount">Â¥0</span>
                    </div>
                    
                    <div class="summary-row">
                        <span class="summary-label">é€æ–™</span>
                        <span class="summary-value" id="shippingAmount">Â¥500</span>
                    </div>
                    
                    <div class="summary-row" id="codFeeRow" style="display: none;">
                        <span class="summary-label">ä»£å¼•æ‰‹æ•°æ–™</span>
                        <span class="summary-value">Â¥300</span>
                    </div>
                    
                    <div class="summary-total">
                        <span class="summary-label">åˆè¨ˆ</span>
                        <span class="summary-value" id="totalAmount">Â¥0</span>
                    </div>

                    <!-- åœ¨åº«ä¸è¶³ã®è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                    <div id="inventoryWarning" style="display: none; background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <span style="font-size: 24px;">âš ï¸</span>
                            <div style="flex: 1;">
                                <h4 style="font-size: 16px; font-weight: 600; color: #856404; margin: 0 0 12px 0;">åœ¨åº«ä¸è¶³ã®ãŠçŸ¥ã‚‰ã›</h4>
                                <div id="inventoryWarningMessage" style="font-size: 14px; color: #856404; line-height: 1.6;"></div>
                                <p style="font-size: 13px; color: #856404; margin: 12px 0 0 0; font-weight: 600;">
                                    â€» ã”æ³¨æ–‡å†…å®¹ã‚’è‡ªå‹•çš„ã«èª¿æ•´ã„ãŸã—ã¾ã—ãŸã€‚ã”äº†æ‰¿ãã ã•ã„ã€‚
                                </p>
                            </div>
                        </div>
                    </div>

                    <button class="place-order-btn" onclick="placeOrder()">æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹</button>
                    
                    <div class="back-to-cart">
                        <a href="cart.html">â† ã‚«ãƒ¼ãƒˆã«æˆ»ã‚‹</a>
                    </div>

                    <div class="secure-notice">
                        <span class="secure-icon">ğŸ”’</span>
                        <span>å®‰å…¨ãªé€šä¿¡ã§ä¿è­·ã•ã‚Œã¦ã„ã¾ã™</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚«ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        let cartItems = [];
        let inventoryAdjusted = false;
        let adjustedItems = [];
        
        try {
            const savedCart = localStorage.getItem('cartItems');
            if (savedCart) {
                cartItems = JSON.parse(savedCart);
            }
        } catch (e) {
            console.error('ã‚«ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        }

        // ã‚«ãƒ¼ãƒˆãŒç©ºã®å ´åˆã¯ã‚«ãƒ¼ãƒˆãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        if (cartItems.length === 0) {
            alert('ã‚«ãƒ¼ãƒˆãŒç©ºã§ã™');
            window.location.href = 'cart.html';
        }

        // åœ¨åº«ãƒã‚§ãƒƒã‚¯ã¨è‡ªå‹•èª¿æ•´
        function checkAndAdjustInventory() {
            if (typeof window.checkInventoryAvailability !== 'function') {
                console.warn('åœ¨åº«ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                return;
            }

            const inventoryCheck = window.checkInventoryAvailability(cartItems);
            
            if (!inventoryCheck.available && inventoryCheck.unavailableItems.length > 0) {
                inventoryAdjusted = true;
                adjustedItems = [];
                
                // åœ¨åº«ä¸è¶³ã®å•†å“ã‚’èª¿æ•´
                inventoryCheck.unavailableItems.forEach(unavailable => {
                    const cartItem = cartItems.find(item => item.name === unavailable.name);
                    if (cartItem) {
                        const originalQuantity = cartItem.quantity;
                        const availableQuantity = Math.max(0, Math.floor(unavailable.available));
                        
                        adjustedItems.push({
                            name: unavailable.name,
                            requested: originalQuantity,
                            available: availableQuantity,
                            adjusted: availableQuantity
                        });
                        
                        if (availableQuantity > 0) {
                            // åœ¨åº«ãŒã‚ã‚‹å ´åˆã¯æ•°é‡ã‚’èª¿æ•´
                            cartItem.quantity = availableQuantity;
                        } else {
                            // åœ¨åº«ãŒãªã„å ´åˆã¯å•†å“ã‚’å‰Šé™¤
                            const index = cartItems.indexOf(cartItem);
                            if (index > -1) {
                                cartItems.splice(index, 1);
                            }
                        }
                    }
                });
                
                // èª¿æ•´å¾Œã®ã‚«ãƒ¼ãƒˆã‚’ä¿å­˜
                localStorage.setItem('cartItems', JSON.stringify(cartItems));
                
                // è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                showInventoryWarning(adjustedItems);
            }
        }

        // åœ¨åº«ä¸è¶³ã®è­¦å‘Šã‚’è¡¨ç¤º
        function showInventoryWarning(adjustedItems) {
            const warningDiv = document.getElementById('inventoryWarning');
            const messageDiv = document.getElementById('inventoryWarningMessage');
            
            let message = '<p style="margin: 0 0 12px 0; font-weight: 600;">èª ã«ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ä»¥ä¸‹ã®å•†å“ã«ã¤ã„ã¦åœ¨åº«ä¸è¶³ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š</p>';
            message += '<ul style="margin: 0; padding-left: 20px;">';
            
            adjustedItems.forEach(item => {
                if (item.adjusted > 0) {
                    message += `<li style="margin: 8px 0;"><strong>${item.name}</strong>ï¼šã”æ³¨æ–‡æ•° ${item.requested}å€‹ â†’ åœ¨åº«æ•° ${item.adjusted}å€‹ã«èª¿æ•´</li>`;
                } else {
                    message += `<li style="margin: 8px 0;"><strong>${item.name}</strong>ï¼šåœ¨åº«åˆ‡ã‚Œã®ãŸã‚å‰Šé™¤ã—ã¾ã—ãŸï¼ˆã”æ³¨æ–‡æ•° ${item.requested}å€‹ï¼‰</li>`;
                }
            });
            
            message += '</ul>';
            message += '<p style="margin: 12px 0 0 0;">åœ¨åº«çŠ¶æ³ã«ã‚ˆã‚Šã€ã”å¸Œæœ›ã®æ•°é‡ã‚’ã”ç”¨æ„ã§ããšã€å¤§å¤‰ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚èª¿æ•´å¾Œã®å†…å®¹ã§ã‚ˆã‚ã—ã‘ã‚Œã°ã€ãã®ã¾ã¾ã”æ³¨æ–‡ã‚’é€²ã‚ã¦ã„ãŸã ã‘ã¾ã™ã€‚</p>';
            
            messageDiv.innerHTML = message;
            warningDiv.style.display = 'block';
            
            // è­¦å‘Šã‚¨ãƒªã‚¢ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            setTimeout(() => {
                warningDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        }

        // åœ¨åº«ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
        checkAndAdjustInventory();

        // ã‚«ãƒ¼ãƒˆãŒç©ºã«ãªã£ãŸå ´åˆã¯ã‚«ãƒ¼ãƒˆãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        if (cartItems.length === 0) {
            alert('ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã™ã¹ã¦ã®å•†å“ãŒåœ¨åº«åˆ‡ã‚Œã®ãŸã‚ã€ã”æ³¨æ–‡ã‚’æ‰¿ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚\nã‚«ãƒ¼ãƒˆãƒšãƒ¼ã‚¸ã«æˆ»ã‚Šã¾ã™ã€‚');
            window.location.href = 'cart.html';
        }

        // æœ€ä½æ³¨æ–‡é‡‘é¡ãƒã‚§ãƒƒã‚¯
        const subtotalCheck = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const MINIMUM_ORDER = 4500;
        if (subtotalCheck < MINIMUM_ORDER) {
            alert(`æœ€ä½æ³¨æ–‡é‡‘é¡ã¯Â¥4,500ã§ã™ï¼ˆé€æ–™åˆ¥ï¼‰ã€‚\nç¾åœ¨ã®å°è¨ˆ: Â¥${subtotalCheck.toLocaleString()}\n${inventoryAdjusted ? 'åœ¨åº«èª¿æ•´ã«ã‚ˆã‚Šæœ€ä½æ³¨æ–‡é‡‘é¡ã‚’ä¸‹å›ã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚' : ''}ã‚«ãƒ¼ãƒˆã«æˆ»ã£ã¦å•†å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚`);
            window.location.href = 'cart.html';
        }

        // æ³¨æ–‡ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
        function renderOrderSummary() {
            const orderItemsContainer = document.getElementById('orderItems');
            const subtotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const shipping = 500;
            let codFee = 0;

            // æ”¯æ‰•ã„æ–¹æ³•ã«ã‚ˆã‚‹æ‰‹æ•°æ–™
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            if (paymentMethod === 'cod') {
                codFee = 300;
                document.getElementById('codFeeRow').style.display = 'flex';
            } else {
                document.getElementById('codFeeRow').style.display = 'none';
            }

            const total = subtotal + shipping + codFee;

            // å•†å“ä¸€è¦§ã‚’è¡¨ç¤º
            orderItemsContainer.innerHTML = cartItems.map(item => `
                <div class="order-item">
                    <div class="order-item-image">
                        <img src="${item.image}" alt="${item.name}">
                    </div>
                    <div class="order-item-details">
                        <div class="order-item-name">${item.name}</div>
                        <div class="order-item-quantity">æ•°é‡: ${item.quantity}</div>
                    </div>
                    <div class="order-item-price">Â¥${(item.price * item.quantity).toLocaleString()}</div>
                </div>
            `).join('');

            // é‡‘é¡ã‚’æ›´æ–°
            document.getElementById('subtotalAmount').textContent = `Â¥${subtotal.toLocaleString()}`;
            document.getElementById('totalAmount').textContent = `Â¥${total.toLocaleString()}`;
        }

        // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        function setupValidation() {
            // éƒµä¾¿ç•ªå·
            const postalCode = document.getElementById('postalCode');
            const postalCodeError = document.getElementById('postalCodeError');
            postalCode.addEventListener('blur', function() {
                validatePostalCode();
                // éƒµä¾¿ç•ªå·ãŒæœ‰åŠ¹ãªå ´åˆã€ä½æ‰€ã‚’è‡ªå‹•å…¥åŠ›
                if (validatePostalCode()) {
                    autoFillAddress();
                }
            });
            postalCode.addEventListener('input', function() {
                // å…¥åŠ›ä¸­ã‚‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒã‚§ãƒƒã‚¯
                if (this.value.length >= 7) {
                    validatePostalCode();
                    // 7æ¡å…¥åŠ›ã•ã‚ŒãŸã‚‰è‡ªå‹•ã§ä½æ‰€ã‚’å–å¾—
                    const cleaned = this.value.replace('-', '');
                    if (cleaned.length === 7) {
                        autoFillAddress();
                    }
                }
            });

            // é›»è©±ç•ªå·
            const phone = document.getElementById('phone');
            const phoneError = document.getElementById('phoneError');
            phone.addEventListener('blur', function() {
                validatePhone();
            });
            phone.addEventListener('input', function() {
                // å…¥åŠ›ä¸­ã‚‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒã‚§ãƒƒã‚¯
                if (this.value.length >= 10) {
                    validatePhone();
                }
            });

            // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
            const email = document.getElementById('email');
            const emailError = document.getElementById('emailError');
            email.addEventListener('blur', function() {
                validateEmail();
            });

            // éƒ½é“åºœçœŒ
            const prefecture = document.getElementById('prefecture');
            const prefectureError = document.getElementById('prefectureError');
            prefecture.addEventListener('change', function() {
                validatePrefecture();
            });

            // å¸‚åŒºç”ºæ‘
            const city = document.getElementById('city');
            const cityError = document.getElementById('cityError');
            city.addEventListener('blur', function() {
                validateCity();
            });

            // ç•ªåœ°ãƒ»å»ºç‰©å
            const address = document.getElementById('address');
            const addressError = document.getElementById('addressError');
            address.addEventListener('blur', function() {
                validateAddress();
            });

            // å§“ãƒ»å
            ['lastName', 'firstName'].forEach(fieldId => {
                const field = document.getElementById(fieldId);
                const error = document.getElementById(fieldId + 'Error');
                if (field && error) {
                    field.addEventListener('blur', function() {
                        if (this.value.trim() === '') {
                            error.style.display = 'block';
                            this.style.borderColor = '#dc3545';
                        } else {
                            error.style.display = 'none';
                            this.style.borderColor = '';
                        }
                    });
                }
            });
        }

        // å€‹åˆ¥ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
        function validatePostalCode() {
            const postalCode = document.getElementById('postalCode');
            const postalCodeError = document.getElementById('postalCodeError');
            const value = postalCode.value.trim();
            const pattern = /^\d{3}-?\d{4}$/;
            
            if (value === '' || !pattern.test(value)) {
                postalCodeError.style.display = 'block';
                postalCode.style.borderColor = '#dc3545';
                return false;
            } else {
                postalCodeError.style.display = 'none';
                postalCode.style.borderColor = '#28a745';
                return true;
            }
        }

        // éƒµä¾¿ç•ªå·ã‹ã‚‰ä½æ‰€ã‚’è‡ªå‹•å…¥åŠ›ã™ã‚‹æ©Ÿèƒ½
        async function autoFillAddress() {
            const postalCode = document.getElementById('postalCode').value.trim().replace('-', '');
            
            if (postalCode.length !== 7) {
                return;
            }

            try {
                const response = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${postalCode}`);
                const data = await response.json();

                if (data.status === 200 && data.results && data.results.length > 0) {
                    const result = data.results[0];
                    const prefecture = result.address1; // éƒ½é“åºœçœŒ
                    const city = result.address2; // å¸‚åŒºç”ºæ‘
                    const town = result.address3; // ç”ºåŸŸ

                    // éƒ½é“åºœçœŒã‚’è‡ªå‹•é¸æŠ
                    const prefectureSelect = document.getElementById('prefecture');
                    const prefectureOption = Array.from(prefectureSelect.options).find(option => option.value === prefecture);
                    if (prefectureOption) {
                        prefectureSelect.value = prefecture;
                        validatePrefecture();
                    }

                    // å¸‚åŒºç”ºæ‘ã‚’è‡ªå‹•å…¥åŠ›
                    const cityInput = document.getElementById('city');
                    if (!cityInput.value.trim()) {
                        cityInput.value = city;
                        validateCity();
                    }

                    // ç”ºåŸŸãŒã‚ã‚‹å ´åˆã€ç•ªåœ°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ææ¡ˆ
                    if (town && !document.getElementById('address').value.trim()) {
                        document.getElementById('address').placeholder = `${town}1-2-3 ã€‡ã€‡ãƒãƒ³ã‚·ãƒ§ãƒ³101`;
                    }

                    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸€æ™‚çš„ã«è¡¨ç¤º
                    const postalCodeError = document.getElementById('postalCodeError');
                    postalCodeError.textContent = `âœ“ ä½æ‰€ã‚’è‡ªå‹•å…¥åŠ›ã—ã¾ã—ãŸ: ${prefecture}${city}`;
                    postalCodeError.style.color = '#28a745';
                    postalCodeError.style.display = 'block';
                    setTimeout(() => {
                        postalCodeError.style.display = 'none';
                        postalCodeError.style.color = '#dc3545';
                        postalCodeError.textContent = 'éƒµä¾¿ç•ªå·ã¯ã€Œ123-4567ã€ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„';
                    }, 3000);
                }
            } catch (error) {
                console.error('ä½æ‰€è‡ªå‹•å…¥åŠ›ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function validatePhone() {
            const phone = document.getElementById('phone');
            const phoneError = document.getElementById('phoneError');
            const value = phone.value.trim();
            // ã‚ˆã‚Šå³æ ¼ãªé›»è©±ç•ªå·ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆãƒã‚¤ãƒ•ãƒ³ã‚ã‚Šãªã—ä¸¡å¯¾å¿œï¼‰
            const pattern = /^(0\d{1,4}-\d{1,4}-\d{4}|0\d{9,10})$/;
            
            if (value === '' || !pattern.test(value)) {
                phoneError.style.display = 'block';
                phone.style.borderColor = '#dc3545';
                return false;
            } else {
                phoneError.style.display = 'none';
                phone.style.borderColor = '#28a745';
                return true;
            }
        }

        function validateEmail() {
            const email = document.getElementById('email');
            const emailError = document.getElementById('emailError');
            const value = email.value.trim();
            const pattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (value === '' || !pattern.test(value)) {
                emailError.style.display = 'block';
                email.style.borderColor = '#dc3545';
                return false;
            } else {
                emailError.style.display = 'none';
                email.style.borderColor = '#28a745';
                return true;
            }
        }

        function validatePrefecture() {
            const prefecture = document.getElementById('prefecture');
            const prefectureError = document.getElementById('prefectureError');
            
            if (prefecture.value === '') {
                prefectureError.style.display = 'block';
                prefecture.style.borderColor = '#dc3545';
                return false;
            } else {
                prefectureError.style.display = 'none';
                prefecture.style.borderColor = '#28a745';
                return true;
            }
        }

        function validateCity() {
            const city = document.getElementById('city');
            const cityError = document.getElementById('cityError');
            const value = city.value.trim();
            
            // å¸‚åŒºç”ºæ‘ã¯æœ€ä½2æ–‡å­—ä»¥ä¸Šã€å…¨è§’æ–‡å­—ã‚’å«ã‚€å¿…è¦ãŒã‚ã‚‹
            if (value === '' || value.length < 2 || !/[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF]/.test(value)) {
                cityError.textContent = 'æœ‰åŠ¹ãªå¸‚åŒºç”ºæ‘åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: éƒ¡å±±å¸‚ï¼‰';
                cityError.style.display = 'block';
                city.style.borderColor = '#dc3545';
                return false;
            } else {
                cityError.style.display = 'none';
                city.style.borderColor = '#28a745';
                return true;
            }
        }

        function validateAddress() {
            const address = document.getElementById('address');
            const addressError = document.getElementById('addressError');
            const value = address.value.trim();
            
            // ç•ªåœ°ã¯æœ€ä½3æ–‡å­—ä»¥ä¸Šã€æ•°å­—ã‚’å«ã‚€å¿…è¦ãŒã‚ã‚‹
            if (value === '' || value.length < 3 || !/\d/.test(value)) {
                addressError.textContent = 'æœ‰åŠ¹ãªç•ªåœ°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: å®‰ç©ç”º1-2-3ï¼‰';
                addressError.style.display = 'block';
                address.style.borderColor = '#dc3545';
                return false;
            } else {
                addressError.style.display = 'none';
                address.style.borderColor = '#28a745';
                return true;
            }
        }

        // éƒµä¾¿ç•ªå·ã‹ã‚‰ä½æ‰€ã‚’æ¤œè¨¼ã™ã‚‹é–¢æ•°
        async function verifyAddressWithPostalCode() {
            const postalCode = document.getElementById('postalCode').value.trim().replace('-', '');
            const prefecture = document.getElementById('prefecture').value;
            const city = document.getElementById('city').value.trim();
            
            if (!postalCode || postalCode.length !== 7) {
                return { valid: false, message: 'éƒµä¾¿ç•ªå·ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“' };
            }

            try {
                // éƒµä¾¿ç•ªå·æ¤œç´¢APIã‚’ä½¿ç”¨ï¼ˆç„¡æ–™ã®zipcloudã‚’ä½¿ç”¨ï¼‰
                const response = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${postalCode}`);
                const data = await response.json();

                if (data.status === 200 && data.results && data.results.length > 0) {
                    const result = data.results[0];
                    const apiPrefecture = result.address1; // éƒ½é“åºœçœŒ
                    const apiCity = result.address2; // å¸‚åŒºç”ºæ‘
                    
                    // éƒ½é“åºœçœŒãŒä¸€è‡´ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    if (prefecture !== apiPrefecture) {
                        return {
                            valid: false,
                            message: `éƒµä¾¿ç•ªå·ã€Œ${postalCode}ã€ã¯ã€Œ${apiPrefecture}ã€ã®éƒµä¾¿ç•ªå·ã§ã™ã€‚\né¸æŠã•ã‚ŒãŸéƒ½é“åºœçœŒã€Œ${prefecture}ã€ã¨ä¸€è‡´ã—ã¾ã›ã‚“ã€‚`,
                            suggestedPrefecture: apiPrefecture,
                            suggestedCity: apiCity
                        };
                    }

                    // å¸‚åŒºç”ºæ‘ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆå®Œå…¨ä¸€è‡´ã§ãªãã¦ã‚‚éƒ¨åˆ†ä¸€è‡´ã§OKï¼‰
                    if (!city.includes(apiCity) && !apiCity.includes(city)) {
                        return {
                            valid: false,
                            message: `éƒµä¾¿ç•ªå·ã€Œ${postalCode}ã€ã¯ã€Œ${apiPrefecture}${apiCity}ã€ã®éƒµä¾¿ç•ªå·ã§ã™ã€‚\nå…¥åŠ›ã•ã‚ŒãŸå¸‚åŒºç”ºæ‘ã€Œ${city}ã€ã¨ä¸€è‡´ã—ã¾ã›ã‚“ã€‚`,
                            suggestedPrefecture: apiPrefecture,
                            suggestedCity: apiCity
                        };
                    }

                    return { 
                        valid: true, 
                        message: 'ä½æ‰€ãŒç¢ºèªã§ãã¾ã—ãŸ',
                        verifiedAddress: `${apiPrefecture}${apiCity}`
                    };
                } else {
                    return { 
                        valid: false, 
                        message: `éƒµä¾¿ç•ªå·ã€Œ${postalCode}ã€ã«è©²å½“ã™ã‚‹ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\næ­£ã—ã„éƒµä¾¿ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`
                    };
                }
            } catch (error) {
                console.error('ä½æ‰€æ¤œè¨¼ã‚¨ãƒ©ãƒ¼:', error);
                // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯åŸºæœ¬çš„ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã¿ã§é€šã™
                return { 
                    valid: true, 
                    message: 'ä½æ‰€æ¤œè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚åŸºæœ¬ãƒã‚§ãƒƒã‚¯ã®ã¿å®Ÿæ–½ã—ã¾ã™ã€‚',
                    warning: true
                };
            }
        }

        // æ”¯æ‰•ã„æ–¹æ³•è©³ç´°ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function showPaymentDetails(method) {
            const detailsArea = document.getElementById('paymentDetails');
            const allDetails = ['creditCardDetails', 'bankTransferDetails', 'codDetails', 'konbiniDetails'];
            
            // ã™ã¹ã¦éè¡¨ç¤º
            allDetails.forEach(id => {
                document.getElementById(id).style.display = 'none';
            });

            // é¸æŠã•ã‚ŒãŸæ”¯æ‰•ã„æ–¹æ³•ã®è©³ç´°ã‚’è¡¨ç¤º
            let targetId = '';
            switch(method) {
                case 'credit':
                    targetId = 'creditCardDetails';
                    break;
                case 'bank':
                    targetId = 'bankTransferDetails';
                    break;
                case 'cod':
                    targetId = 'codDetails';
                    break;
                case 'konbini':
                    targetId = 'konbiniDetails';
                    break;
            }

            if (targetId) {
                detailsArea.style.display = 'block';
                document.getElementById(targetId).style.display = 'block';
            }
        }

        // æ”¯æ‰•ã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’ç®¡ç†
        document.querySelectorAll('.payment-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                const radio = this.querySelector('input[type="radio"]');
                radio.checked = true;
                showPaymentDetails(radio.value); // æ”¯æ‰•ã„è©³ç´°ã‚’è¡¨ç¤º
                renderOrderSummary(); // ä»£å¼•æ‰‹æ•°æ–™ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            });
        });

        // ç™ºé€å…ˆæƒ…å ±ã®è©³ç´°ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        function validateShippingInfo() {
            let isValid = true;
            const errors = [];

            // å§“ãƒ»å
            const lastName = document.getElementById('lastName').value.trim();
            const firstName = document.getElementById('firstName').value.trim();
            if (!lastName || lastName.length === 0) {
                errors.push('å§“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                document.getElementById('lastNameError').style.display = 'block';
                document.getElementById('lastName').style.borderColor = '#dc3545';
                isValid = false;
            }
            if (!firstName || firstName.length === 0) {
                errors.push('åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                document.getElementById('firstNameError').style.display = 'block';
                document.getElementById('firstName').style.borderColor = '#dc3545';
                isValid = false;
            }

            // å€‹åˆ¥ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ã‚’å‘¼ã³å‡ºã™
            if (!validateEmail()) {
                errors.push('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                isValid = false;
            }

            if (!validatePhone()) {
                errors.push('æœ‰åŠ¹ãªé›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 090-1234-5678 ã¾ãŸã¯ 09012345678ï¼‰');
                isValid = false;
            }

            if (!validatePostalCode()) {
                errors.push('æœ‰åŠ¹ãªéƒµä¾¿ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 123-4567 ã¾ãŸã¯ 1234567ï¼‰');
                isValid = false;
            }

            if (!validatePrefecture()) {
                errors.push('éƒ½é“åºœçœŒã‚’é¸æŠã—ã¦ãã ã•ã„');
                isValid = false;
            }

            if (!validateCity()) {
                errors.push('æœ‰åŠ¹ãªå¸‚åŒºç”ºæ‘åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: éƒ¡å±±å¸‚ï¼‰');
                isValid = false;
            }

            if (!validateAddress()) {
                errors.push('æœ‰åŠ¹ãªç•ªåœ°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: å®‰ç©ç”º1-2-3ï¼‰');
                isValid = false;
            }

            if (!isValid) {
                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚ˆã‚Šè¦‹ã‚„ã™ãè¡¨ç¤º
                alert('âŒ ç™ºé€å…ˆæƒ…å ±ã«ä¸å‚™ãŒã‚ã‚Šã¾ã™\n\n' + errors.map((e, i) => `${i + 1}. ${e}`).join('\n') + '\n\næ­£ã—ã„æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                // æœ€åˆã®ã‚¨ãƒ©ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                const firstErrorField = document.querySelector('input[style*="border-color: rgb(220, 53, 69)"], select[style*="border-color: rgb(220, 53, 69)"]');
                if (firstErrorField) {
                    firstErrorField.focus();
                    firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            return isValid;
        }

        // æ”¯æ‰•ã„æ–¹æ³•åˆ¥ã®å‡¦ç†
        function processPayment(orderData) {
            const paymentMethod = orderData.paymentMethod;
            
            switch(paymentMethod) {
                case 'credit':
                    // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆã®å ´åˆ
                    console.log('ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆã‚’å‡¦ç†ã—ã¾ã™');
                    // å®Ÿéš›ã«ã¯æ±ºæ¸ˆä»£è¡Œã‚µãƒ¼ãƒ“ã‚¹ã®APIã‚’å‘¼ã³å‡ºã™
                    // ä¾‹: Stripe, PAY.JP, GMOãƒšã‚¤ãƒ¡ãƒ³ãƒˆã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ãªã©
                    // return initiateCreditCardPayment(orderData);
                    orderData.paymentStatus = 'pending'; // æ±ºæ¸ˆå¾…ã¡
                    orderData.paymentInstructions = 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆç”»é¢ã«ç§»å‹•ã—ã¾ã™ã€‚';
                    break;

                case 'bank':
                    // éŠ€è¡ŒæŒ¯è¾¼ã®å ´åˆ
                    console.log('éŠ€è¡ŒæŒ¯è¾¼ã®æ³¨æ–‡ã‚’å‡¦ç†ã—ã¾ã™');
                    orderData.paymentStatus = 'awaiting_transfer'; // æŒ¯è¾¼å¾…ã¡
                    orderData.paymentInstructions = 'æŒ¯è¾¼å…ˆå£åº§æƒ…å ±ã‚’ãƒ¡ãƒ¼ãƒ«ã§ãŠé€ã‚Šã—ã¾ã—ãŸã€‚7æ—¥ä»¥å†…ã«ãŠæŒ¯è¾¼ã¿ãã ã•ã„ã€‚';
                    orderData.bankInfo = {
                        bankName: 'ã€‡ã€‡éŠ€è¡Œ',
                        branchName: 'ã€‡ã€‡æ”¯åº—',
                        accountType: 'æ™®é€š',
                        accountNumber: '1234567',
                        accountHolder: 'å®‰ç©ç›´å£²æ‰€'
                    };
                    break;

                case 'cod':
                    // ä»£é‡‘å¼•æ›ã®å ´åˆ
                    console.log('ä»£é‡‘å¼•æ›ã®æ³¨æ–‡ã‚’å‡¦ç†ã—ã¾ã™');
                    orderData.paymentStatus = 'cod_pending'; // é…é”æ™‚æ”¯æ‰•ã„
                    orderData.paymentInstructions = 'å•†å“å—å–æ™‚ã«é…é”å“¡ã¸ç¾é‡‘ã§ãŠæ”¯æ‰•ã„ãã ã•ã„ã€‚';
                    orderData.codAmount = orderData.subtotal + orderData.shipping + orderData.codFee;
                    break;

                case 'konbini':
                    // ã‚³ãƒ³ãƒ“ãƒ‹æ±ºæ¸ˆã®å ´åˆ
                    console.log('ã‚³ãƒ³ãƒ“ãƒ‹æ±ºæ¸ˆã®æ³¨æ–‡ã‚’å‡¦ç†ã—ã¾ã™');
                    orderData.paymentStatus = 'awaiting_payment'; // æ”¯æ‰•ã„å¾…ã¡
                    orderData.paymentInstructions = 'ãŠæ”¯æ‰•ã„ç•ªå·ã‚’ãƒ¡ãƒ¼ãƒ«ã§ãŠé€ã‚Šã—ã¾ã—ãŸã€‚7æ—¥ä»¥å†…ã«ã‚³ãƒ³ãƒ“ãƒ‹ã§ãŠæ”¯æ‰•ã„ãã ã•ã„ã€‚';
                    // æ”¯æ‰•ã„ç•ªå·ã‚’ç”Ÿæˆï¼ˆå®Ÿéš›ã«ã¯APIã‹ã‚‰å–å¾—ï¼‰
                    orderData.paymentNumber = 'KB-' + Date.now().toString().slice(-10);
                    break;

                default:
                    console.error('ä¸æ˜ãªæ”¯æ‰•ã„æ–¹æ³•:', paymentMethod);
                    return false;
            }

            orderData.orderDate = new Date().toISOString();
            orderData.orderId = 'ORD-' + Date.now();
            
            return true;
        }

        // æ³¨æ–‡ç¢ºå®š
        async function placeOrder() {
            const form = document.getElementById('checkoutForm');
            
            // åŸºæœ¬çš„ãªãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // ç™ºé€å…ˆæƒ…å ±ã®è©³ç´°ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!validateShippingInfo()) {
                return;
            }

            // æœ€ä½æ³¨æ–‡é‡‘é¡ã®å†ãƒã‚§ãƒƒã‚¯
            const subtotalCheck = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const MINIMUM_ORDER = 4500;
            
            if (subtotalCheck < MINIMUM_ORDER) {
                alert(`æœ€ä½æ³¨æ–‡é‡‘é¡ã¯Â¥4,500ã§ã™ï¼ˆé€æ–™åˆ¥ï¼‰ã€‚\nç¾åœ¨ã®å°è¨ˆ: Â¥${subtotalCheck.toLocaleString()}\nã‚«ãƒ¼ãƒˆã«æˆ»ã£ã¦å•†å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚`);
                window.location.href = 'cart.html';
                return;
            }

            // ä½æ‰€ã®å®Ÿåœ¨æ€§ã‚’ç¢ºèª
            const placeOrderBtn = document.querySelector('.place-order-btn');
            placeOrderBtn.disabled = true;
            placeOrderBtn.textContent = 'ä½æ‰€ã‚’ç¢ºèªä¸­...';
            
            const addressVerification = await verifyAddressWithPostalCode();
            
            if (!addressVerification.valid) {
                placeOrderBtn.disabled = false;
                placeOrderBtn.textContent = 'æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹';
                
                // ä½æ‰€ãŒå®Ÿåœ¨ã—ãªã„å ´åˆã¯è©³ç´°ãªã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
                let errorMessage = 'âŒ å…¥åŠ›ã•ã‚ŒãŸä½æ‰€ã‚’ç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸ\n\n' + addressVerification.message;
                
                if (addressVerification.suggestedPrefecture && addressVerification.suggestedCity) {
                    errorMessage += `\n\nğŸ’¡ æ­£ã—ã„ä½æ‰€:\n${addressVerification.suggestedPrefecture}${addressVerification.suggestedCity}`;
                }
                
                errorMessage += '\n\nå…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ã€æ­£ã—ã„ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                
                alert(errorMessage);
                
                // éƒµä¾¿ç•ªå·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                document.getElementById('postalCode').focus();
                document.getElementById('postalCode').scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }
            
            // è­¦å‘ŠãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤ºï¼ˆæ¥ç¶šã‚¨ãƒ©ãƒ¼ãªã©ï¼‰
            if (addressVerification.warning) {
                console.warn(addressVerification.message);
            }
            
            placeOrderBtn.textContent = 'æ³¨æ–‡ã‚’å‡¦ç†ä¸­...';
            placeOrderBtn.style.background = '#28a745';

            const formData = new FormData(form);
            
            // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
            const currentUser = window.Auth ? window.Auth.getCurrentUser() : null;
            if (!currentUser) {
                alert('ãƒ­ã‚°ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                window.location.href = 'login.html?redirect=checkout.html';
                return;
            }
            
            // 1. ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
            if (typeof createCheckoutSession === 'function') {
                createCheckoutSession(cartItems);
            }
            
            // 2. ã‚µãƒ¼ãƒãƒ¼å´ã§é‡‘é¡å†è¨ˆç®—ï¼ˆæ”¹ã–ã‚“é˜²æ­¢ï¼‰
            let serverCalculation;
            try {
                if (typeof recalculateOrderTotal === 'function') {
                    placeOrderBtn.textContent = 'é‡‘é¡ã‚’æ¤œè¨¼ä¸­...';
                    serverCalculation = recalculateOrderTotal(cartItems);
                    console.log('[é‡‘é¡å†è¨ˆç®—]', serverCalculation);
                } else {
                    throw new Error('é‡‘é¡è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
            } catch (error) {
                alert('é‡‘é¡è¨ˆç®—ã‚¨ãƒ©ãƒ¼: ' + error.message);
                placeOrderBtn.disabled = false;
                placeOrderBtn.textContent = 'æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹';
                placeOrderBtn.style.background = '';
                return;
            }
            
            // 3. æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ä½œæˆ
            const orderData = {
                orderId: 'ORD_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                userId: currentUser.id,
                customerInfo: {
                    lastName: formData.get('lastName'),
                    firstName: formData.get('firstName'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                },
                shippingInfo: {
                    postalCode: formData.get('postalCode'),
                    prefecture: formData.get('prefecture'),
                    city: formData.get('city'),
                    address: formData.get('address'),
                    note: formData.get('deliveryNote')
                },
                paymentMethod: formData.get('paymentMethod'),
                items: serverCalculation.items,  // ã‚µãƒ¼ãƒãƒ¼è¨ˆç®—å€¤ã‚’ä½¿ç”¨
                amounts: {
                    subtotal: serverCalculation.subtotal,
                    tax: serverCalculation.totalTax,
                    shipping: serverCalculation.shippingTotal,
                    total: serverCalculation.finalTotal
                },
                calculationHash: serverCalculation.calculationHash,
                createdAt: new Date().toISOString()
            };

            console.log('[æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿]', orderData);

            // 4. æ±ºæ¸ˆå‡¦ç†
            try {
                placeOrderBtn.textContent = 'æ±ºæ¸ˆå‡¦ç†ä¸­...';
                
                const paymentMethod = formData.get('paymentMethod');
                let paymentConfig;
                
                // æ±ºæ¸ˆæ–¹æ³•åˆ¥ã®è¨­å®š
                switch(paymentMethod) {
                    case 'credit':
                        paymentConfig = {
                            type: window.PAYMENT_PROVIDERS.STRIPE,
                            // å®Ÿè£…æ™‚: Stripe Elements ã®ã‚«ãƒ¼ãƒ‰è¦ç´ ã‚’å–å¾—
                            cardElement: null,  
                            clientSecret: null  // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—
                        };
                        break;
                        
                    case 'konbini':
                        paymentConfig = {
                            type: window.PAYMENT_PROVIDERS.KONBINI
                        };
                        break;
                        
                    case 'paypay':
                        paymentConfig = {
                            type: window.PAYMENT_PROVIDERS.PAYPAY,
                            returnUrl: window.location.origin + '/order-complete.html'
                        };
                        break;
                        
                    case 'cod':
                        // ä»£é‡‘å¼•æ›ã¯æ±ºæ¸ˆä¸è¦
                        paymentConfig = { type: 'cod' };
                        break;
                        
                    default:
                        throw new Error('ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„æ±ºæ¸ˆæ–¹æ³•ã§ã™');
                }
                
                // æ±ºæ¸ˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§å‡¦ç†
                let paymentResult;
                
                if (paymentConfig.type === 'cod') {
                    // ä»£é‡‘å¼•æ›ã®å ´åˆã¯æ±ºæ¸ˆå‡¦ç†ã‚¹ã‚­ãƒƒãƒ—
                    paymentResult = {
                        success: true,
                        paymentMethod: 'cod',
                        message: 'é…é”æ™‚ã«ç¾é‡‘ã§ãŠæ”¯æ‰•ã„ãã ã•ã„'
                    };
                } else if (window.PaymentManager) {
                    const paymentManager = new window.PaymentManager();
                    
                    // StripeåˆæœŸåŒ–ï¼ˆå®Ÿè£…æ™‚: å®Ÿéš›ã®APIã‚­ãƒ¼ã‚’ä½¿ç”¨ï¼‰
                    if (paymentConfig.type === window.PAYMENT_PROVIDERS.STRIPE) {
                        // await paymentManager.initializeStripe('pk_test_xxxxx');
                        // é–‹ç™ºä¸­ã¯ä»®ã®æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹
                        paymentResult = {
                            success: true,
                            paymentId: 'dev_payment_' + Date.now(),
                            message: 'ã€é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã€‘æ±ºæ¸ˆå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ'
                        };
                    } else {
                        // å®Ÿéš›ã®æ±ºæ¸ˆå‡¦ç†
                        // paymentResult = await paymentManager.processPayment(orderData, paymentConfig);
                        
                        // é–‹ç™ºä¸­ã¯ä»®ã®æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹
                        paymentResult = {
                            success: true,
                            paymentId: 'dev_payment_' + Date.now(),
                            message: 'ã€é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã€‘æ±ºæ¸ˆå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ'
                        };
                    }
                } else {
                    // PaymentManagerãŒåˆ©ç”¨ã§ããªã„å ´åˆ
                    console.warn('[æ±ºæ¸ˆ] PaymentManagerãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§ç¶šè¡Œã—ã¾ã™ã€‚');
                    paymentResult = {
                        success: true,
                        paymentId: 'dev_payment_' + Date.now(),
                        message: 'ã€é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã€‘æ±ºæ¸ˆå‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ'
                    };
                }
                
                if (!paymentResult.success) {
                    throw new Error(paymentResult.error || 'æ±ºæ¸ˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                console.log('[æ±ºæ¸ˆå®Œäº†]', paymentResult);
                
                // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã«æ±ºæ¸ˆæƒ…å ±ã‚’è¿½åŠ 
                orderData.payment = {
                    method: paymentMethod,
                    status: 'completed',
                    paymentId: paymentResult.paymentId,
                    processedAt: new Date().toISOString()
                };
                
            } catch (error) {
                console.error('[æ±ºæ¸ˆã‚¨ãƒ©ãƒ¼]', error);
                alert('æ±ºæ¸ˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                placeOrderBtn.disabled = false;
                placeOrderBtn.textContent = 'æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹';
                placeOrderBtn.style.background = '';
                return;
            }

            // 5. çµ±åˆæ³¨æ–‡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã«æ³¨æ–‡ã‚’ç™»éŒ²
            // 5. çµ±åˆæ³¨æ–‡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã«æ³¨æ–‡ã‚’ç™»éŒ²
            if (window.OrderSync) {
                try {
                    placeOrderBtn.textContent = 'æ³¨æ–‡ã‚’ç™»éŒ²ä¸­...';
                    
                    // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã‚·ã‚¹ãƒ†ãƒ ã«è¿½åŠ 
                    const orderResult = window.OrderSync.addOrder({
                        orderNumber: orderData.orderId,
                        customerInfo: orderData.customerInfo,
                        items: orderData.items.map(item => ({
                            productId: item.id,
                            productName: item.name,
                            quantity: item.quantity,
                            unitPrice: item.price
                        })),
                        totalAmount: orderData.amounts.total,
                        shippingInfo: orderData.shippingInfo,
                        paymentMethod: orderData.paymentMethod,
                        notes: orderData.shippingInfo.note
                    }, window.ORDER_SOURCE.EC_SITE);

                    if (!orderResult.success) {
                        if (orderResult.error === 'duplicate') {
                            console.warn('âš  ã“ã®æ³¨æ–‡ã¯æ—¢ã«å‡¦ç†æ¸ˆã¿ã§ã™');
                        } else {
                            throw new Error('æ³¨æ–‡ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + orderResult.error);
                        }
                    } else {
                        console.log('âœ“ æ³¨æ–‡ã‚’çµ±åˆã‚·ã‚¹ãƒ†ãƒ ã«ç™»éŒ²ã—ã¾ã—ãŸ:', orderResult.orderId);
                        
                        // åœ¨åº«å‡¦ç†ã‚’å®Ÿè¡Œï¼ˆé‡è¤‡é˜²æ­¢ä»˜ãï¼‰
                        placeOrderBtn.textContent = 'åœ¨åº«ã‚’æ›´æ–°ä¸­...';
                        const inventoryResult = window.OrderSync.processInventory(orderResult.orderId);
                        
                        if (!inventoryResult.success) {
                            if (inventoryResult.error === 'already_processed') {
                                console.warn('âš  ã“ã®æ³¨æ–‡ã®åœ¨åº«ã¯æ—¢ã«å‡¦ç†æ¸ˆã¿ã§ã™');
                            } else if (inventoryResult.error === 'insufficient_stock') {
                                alert(`åœ¨åº«ä¸è¶³: ${inventoryResult.productName}\nç¾åœ¨ã®åœ¨åº«: ${inventoryResult.available}\næ³¨æ–‡æ•°é‡: ${inventoryResult.requested}`);
                                
                                // ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
                                if (typeof releasePurchaseLock === 'function') {
                                    orderData.items.forEach(item => {
                                        releasePurchaseLock(item.id, currentUser.id);
                                    });
                                }
                                
                                placeOrderBtn.disabled = false;
                                placeOrderBtn.textContent = 'æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹';
                                placeOrderBtn.style.background = '';
                                return;
                            } else {
                                throw new Error('åœ¨åº«å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + inventoryResult.error);
                            }
                        } else {
                            console.log('âœ“ åœ¨åº«ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                        }
                    }
                } catch (error) {
                    console.error('æ³¨æ–‡å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                    alert('æ³¨æ–‡å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                    placeOrderBtn.disabled = false;
                    placeOrderBtn.textContent = 'æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹';
                    placeOrderBtn.style.background = '';
                    return;
                }
            }
            
            // 6. æ³¨æ–‡å±¥æ­´ã«è¿½åŠ 
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const newOrder = {
                userId: currentUser.id,
                orderNumber: orderData.orderId,
                orderDate: orderData.orderDate,
                status: 'pending', // æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                items: orderData.items,
                subtotal: orderData.subtotal,
                shipping: orderData.shipping,
                codFee: orderData.codFee,
                total: orderData.subtotal + orderData.shipping + orderData.codFee,
                customer: orderData.customer,
                shippingAddress: orderData.shipping,
                paymentMethod: orderData.paymentMethod,
                paymentStatus: orderData.paymentStatus
            };
            orders.push(newOrder);
            localStorage.setItem('orders', JSON.stringify(orders));
            console.log('âœ“ æ³¨æ–‡å±¥æ­´ã«è¿½åŠ ã—ã¾ã—ãŸ');
                    placeOrderBtn.textContent = 'æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹';
                    placeOrderBtn.style.background = '';
                    return;
                }
            } else {
                console.warn('âš  çµ±åˆæ³¨æ–‡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
            }

            // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
            localStorage.setItem('lastOrder', JSON.stringify(orderData));

            // 7. ã‚«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
            placeOrderBtn.textContent = 'æ³¨æ–‡ã‚’å®Œäº†ã—ã¦ã„ã¾ã™...';
            localStorage.removeItem('cartItems');
            console.log('âœ“ ã‚«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
            
            // 8. ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªã‚¢
            if (typeof clearCheckoutSession === 'function') {
                clearCheckoutSession();
            }
            
            console.log('âœ… æ³¨æ–‡å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ');
            
            placeOrderBtn.textContent = 'æ³¨æ–‡å®Œäº†ï¼';
            placeOrderBtn.style.background = '#28a745';

            // æ³¨æ–‡å®Œäº†ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            setTimeout(() => {
                window.location.href = 'order-complete.html?orderId=' + orderData.orderId;
            }, 500);
        }

        // åˆæœŸè¡¨ç¤º
        renderOrderSummary();
        setupValidation();
        showPaymentDetails('credit'); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰è©³ç´°ã‚’è¡¨ç¤º
    </script>
</body>
</html>
